import logging
from aiogram import Router, Bot, types
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, ErrorEvent
from aiogram.exceptions import TelegramAPIError
from config import ADMIN_USER_ID

# –°—Ç–≤–æ—Ä—é—î–º–æ —Ä–æ—É—Ç–µ—Ä –¥–ª—è –∑–∞–≥–∞–ª—å–Ω–∏—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤. –¶–µ –¥–æ–∑–≤–æ–ª—è—î –≥—Ä—É–ø—É–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É.
general_router = Router(name="general_router")
logger = logging.getLogger(__name__)

# –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞, —è–∫—â–æ –º–∏ —ñ–º–ø–æ—Ä—Ç—É—î–º–æ —Ä–æ—É—Ç–µ—Ä –Ω–∞–ø—Ä—è–º—É –≤ main.py,
# –∞–ª–µ —è –∑–∞–ª–∏—à–∞—é —ó—ó, —è–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ —Ç–∞–∫–∏–π –ø–∞—Ç–µ—Ä–Ω –≤ —ñ–Ω—à–∏—Ö –º—ñ—Å—Ü—è—Ö.
def register_general_handlers(dp):
    dp.include_router(general_router)

@general_router.message(CommandStart())
async def cmd_start(message: types.Message):
    """
    –û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /start. –í—ñ—Ç–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
    """
    start_message = (
        "<b>–í—ñ—Ç–∞—é! –Ø MLBB IUI mini.</b>\n\n"
        "–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —ñ–≥—Ä–æ–≤–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —É Mobile Legends: Bang Bang.\n\n"
        "<b>–©–æ —è –≤–º—ñ—é:</b>\n"
        "‚ñ∫ –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏ –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –º–∞—Ç—á—ñ–≤.\n"
        "‚ñ∫ –ù–∞–¥–∞–≤–∞—Ç–∏ –ø–æ—Ä–∞–¥–∏ —â–æ–¥–æ –∑–±—ñ—Ä–æ–∫ —Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥—ñ–π.\n"
        "‚ñ∫ –í—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –≥—Ä—É.\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –º–µ–Ω—ñ —Å–∫—Ä—ñ–Ω—à–æ—Ç, —ñ —è –ø–æ—á–Ω—É –∞–Ω–∞–ª—ñ–∑!"
    )
    await message.answer(start_message)

@general_router.message(Command("help"))
async def cmd_help(message: types.Message):
    """
    –û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /help. –ù–∞–¥–∞—î –¥–æ–≤—ñ–¥–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é.
    """
    help_text = (
        "<b>–î–æ–≤—ñ–¥–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:</b>\n\n"
        "<code>/start</code> - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞ —Ç–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ—Ç–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.\n"
        "<code>/help</code> - –ü–æ–∫–∞–∑–∞—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.\n\n"
        "<b>–û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å:</b>\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (—Å–∫—Ä—ñ–Ω—à–æ—Ç) –∑ –≥—Ä–∏ –≤ —Ü–µ–π —á–∞—Ç. –Ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –π–æ–≥–æ –æ–±—Ä–æ–±–ª—é —Ç–∞ –Ω–∞–¥–∞–º –¥–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑."
    )
    await message.answer(help_text)

async def cmd_go(message: types.Message, **data):
    """
    –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ª–æ–≥—ñ–∫–∏ –∫–æ–º–∞–Ω–¥–∏ /go.
    –¶—è —Ñ—É–Ω–∫—Ü—ñ—è, –π–º–æ–≤—ñ—Ä–Ω–æ, –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑ —ñ–Ω—à–æ–≥–æ –æ–±—Ä–æ–±–Ω–∏–∫–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, vision_handler),
    —Ç–æ–º—É –≤–æ–Ω–∞ –Ω–µ –¥–µ–∫–æ—Ä–æ–≤–∞–Ω–∞ —è–∫ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.
    """
    await message.reply("–ö–æ–º–∞–Ω–¥–∞ /go –Ω–∞—Ä–∞–∑—ñ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ.")

async def general_error_handler(event: ErrorEvent, bot: Bot):
    """
    –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è aiogram 3.x.
    –õ–æ–≥—É—î –≤—Å—ñ –≤–∏–Ω—è—Ç–∫–∏ —Ç–∞ —Å–ø–æ–≤—ñ—â–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞/–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

    Args:
        event (ErrorEvent): –û–±'—î–∫—Ç, —â–æ –º—ñ—Å—Ç–∏—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –≤–∏–Ω—è—Ç–æ–∫.
        bot (Bot): –ï–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞, –ø–µ—Ä–µ–¥–∞–Ω–∏–π –ø—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.
    """
    logger.error(f"–ü–æ–º–∏–ª–∫–∞ –≤ –æ–±—Ä–æ–±–Ω–∏–∫—É: {event.exception}", exc_info=True)

    user_message = "üî¥ <b>–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞</b>\n\n–ù–∞ –∂–∞–ª—å, –ø—ñ–¥ —á–∞—Å –æ–±—Ä–æ–±–∫–∏ –≤–∞—à–æ–≥–æ –∑–∞–ø–∏—Ç—É –≤–∏–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞. –°–ø—Ä–æ–±—É–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞, –ø—ñ–∑–Ω—ñ—à–µ."
    chat_id = event.update.message.chat.id if event.update.message else None

    if chat_id:
        try:
            await bot.send_message(chat_id, user_message)
        except Exception as e:
            logger.error(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É –≤ —á–∞—Ç {chat_id}: {e}")

    # –ù–∞–¥—Å–∏–ª–∞—î–º–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É
    if ADMIN_USER_ID:
        try:
            admin_message = (
                f"‚ö†Ô∏è <b>–ó–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ –ø–æ–º–∏–ª–∫—É –≤ –±–æ—Ç—ñ!</b>\n\n"
                f"<b>–¢–∏–ø –ø–æ–º–∏–ª–∫–∏:</b> <code>{type(event.exception).__name__}</code>\n"
                f"<b>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:</b> <code>{event.exception}</code>\n\n"
                f"<b>Update ID:</b> <code>{event.update.update_id}</code>"
            )
            await bot.send_message(ADMIN_USER_ID, admin_message)
        except Exception as e:
            logger.error(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–≤—ñ—Ç –ø—Ä–æ –ø–æ–º–∏–ª–∫—É –∞–¥–º—ñ–Ω—É {ADMIN_USER_ID}: {e}")
