"""
–°–µ—Ä–≤—ñ—Å–Ω–∏–π –º–æ–¥—É–ª—å –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ Google Vertex AI.

–¶–µ–π —Ñ–∞–π–ª —ñ–Ω–∫–∞–ø—Å—É–ª—é—î –≤—Å—é –ª–æ–≥—ñ–∫—É –¥–ª—è:
- –†–æ–±–æ—Ç–∏ –∑ Gemini —á–µ—Ä–µ–∑ –ø—Ä–æ–¥–∞–∫—à–Ω-–µ–Ω–¥–ø–æ—ñ–Ω—Ç Vertex AI, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–ª–∞—Ç–Ω–∏–π —Ç–∞—Ä–∏—Ñ.
- –ù–∞–¥—ñ–π–Ω–æ—ó –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤–±—É–¥–æ–≤–∞–Ω–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É "Google Search".
- –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏ (Exponential Backoff) –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Å–ø—Ä–æ–±.
"""
import logging
import os
from typing import Optional
from datetime import datetime, timezone

# üîΩ –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π SDK –¥–ª—è Vertex AI - —Ü–µ –∫–ª—é—á –¥–æ –ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
import vertexai
from vertexai.generative_models import GenerativeModel, Tool
from google.api_core.exceptions import ResourceExhausted, GoogleAPIError

# üîΩ –î–æ–¥–∞—î–º–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –¥–ª—è "—Ä–æ–∑—É–º–Ω–∏—Ö" –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Å–ø—Ä–æ–± - —Å—Ç–∞–Ω–¥–∞—Ä—Ç —è–∫–æ—Å—Ç—ñ
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type

# –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –ª–æ–≥–µ—Ä
from config import logger

# === –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø VERTEX AI ===
try:
    # –ó—á–∏—Ç—É—î–º–æ ID –ø—Ä–æ—î–∫—Ç—É, —è–∫–∏–π —Ç–∏ –¥–æ–¥–∞–≤ —É Heroku. –¶–µ –Ω–∞—à "–∫–ª—é—á" –≤—ñ–¥ –ø–ª–∞—Ç–Ω–æ–≥–æ –≤—Ö–æ–¥—É.
    GOOGLE_CLOUD_PROJECT_ID = os.getenv('GOOGLE_CLOUD_PROJECT_ID')
    if not GOOGLE_CLOUD_PROJECT_ID:
        raise ValueError("–ó–º—ñ–Ω–Ω–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ GOOGLE_CLOUD_PROJECT_ID –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –¶–µ –∫–ª—é—á –¥–æ –ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É.")
    
    # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ Vertex AI, –≤–∫–∞–∑—É—é—á–∏ –Ω–∞—à –ø—Ä–æ—î–∫—Ç.
    vertexai.init(project=GOOGLE_CLOUD_PROJECT_ID, location="us-central1")
    logger.info(f"‚úÖ –°–µ—Ä–≤—ñ—Å Vertex AI —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è –ø—Ä–æ—î–∫—Ç—É '{GOOGLE_CLOUD_PROJECT_ID}'.")

except (ValueError, ImportError) as e:
    logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Vertex AI: {e}")


class GeminiSearch:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –∫–ª—ñ—î–Ω—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ Gemini —á–µ—Ä–µ–∑ Vertex AI,
    —â–æ –≥–∞—Ä–∞–Ω—Ç—É—î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø–ª–∞—Ç–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ—É —Ç–∞ –≤–∏—Å–æ–∫—É –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å.
    """
    def __init__(self):
        # üîΩ –í–ò–ö–û–†–ò–°–¢–û–í–£–Ñ–ú–û –¢–ï, –©–û –¢–û–ë–Ü –ü–û–¢–†–Ü–ë–ù–û:
        # –ù–∞–∑–≤–∞ 'gemini-1.5-pro-latest' - —Ü–µ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π —Ç–µ—Ö–Ω—ñ—á–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –¥–ª—è —Ñ–ª–∞–≥–º–∞–Ω—Å—å–∫–æ—ó
        # –º–æ–¥–µ–ª—ñ Pro. –¢–µ–≥ "-latest" –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ —Ç–∏ –∑–∞–≤–∂–¥–∏ –æ—Ç—Ä–∏–º—É—î—à –¥–æ—Å—Ç—É–ø –¥–æ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö
        # –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π, –∞–Ω–æ–Ω—Å–æ–≤–∞–Ω–∏—Ö —è–∫ "2.5 Pro".
        self.model = GenerativeModel(
            "gemini-1.5-pro-latest",
            tools=[Tool.from_google_search_retrieval()] # –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π —Å–ø–æ—Å—ñ–± –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –ø–æ—à—É–∫—É –¥–ª—è Vertex AI
        )
        logger.info(f"–ú–æ–¥–µ–ª—å –¥–ª—è –ø–æ—à—É–∫—É: gemini-1.5-pro-latest (Vertex AI), —â–æ –Ω–∞–¥–∞—î –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ '2.5 Pro', –∑ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–º Google Search.")

    # üîΩ –î–µ–∫–æ—Ä–∞—Ç–æ—Ä Tenacity –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Å–ø—Ä–æ–±
    @retry(
        wait=wait_exponential(multiplier=1, min=2, max=30), # –ó–∞—Ç—Ä–∏–º–∫–∞: 2—Å, 4—Å, 8—Å...
        stop=stop_after_attempt(3), # –ú–∞–∫—Å–∏–º—É–º 3 —Å–ø—Ä–æ–±–∏
        retry=retry_if_exception_type(ResourceExhausted), # –ü–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö –∫–≤–æ—Ç–∏
        before_sleep=lambda retry_state: logger.warning(f"–ü–µ—Ä–µ–≤–∏—â–µ–Ω–æ –∫–≤–æ—Ç—É Vertex AI, –ø–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞ —á–µ—Ä–µ–∑ {retry_state.next_action.sleep:.0f}—Å...")
    )
    async def get_search_response(self, user_query: str, user_name: str) -> Optional[str]:
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤–∏–∫–æ–Ω—É—î –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç –¥–æ Gemini —á–µ—Ä–µ–∑ Vertex AI.
        """
        prompt = f"""
        **–ó–ê–í–î–ê–ù–ù–Ø:** –¢–∏ ‚Äî AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –≥—Ä–∞–≤—Ü—ñ–≤ Mobile Legends. –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –Ω–∞–¥–∞—Ç–∏ –≤–∏—á–µ—Ä–ø–Ω—É —Ç–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –∑–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –¥–æ—Å—Ç—É–ø –¥–æ Google Search.
        **–ö–û–ù–¢–ï–ö–°–¢:**
        - –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: {user_name}
        - –ü–æ—Ç–æ—á–Ω–∞ –¥–∞—Ç–∞: {datetime.now(timezone.utc).strftime('%Y-%m-%d')}
        - –ó–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: "{user_query}"
        **–ö–†–ò–¢–ò–ß–ù–Ü –Ü–ù–°–¢–†–£–ö–¶–Ü–á:**
        1. **–ü–†–Ø–ú–ê –í–Ü–î–ü–û–í–Ü–î–¨:** –ù–∞–¥–∞–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ. –ù–µ –ø–æ—Å–∏–ª–∞–π—Å—è –Ω–∞ –¥–∂–µ—Ä–µ–ª–∞, –∞ —Å–∏–Ω—Ç–µ–∑—É–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –Ω–∏—Ö —É —î–¥–∏–Ω—É, —á—ñ—Ç–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å.
        2. **–ó–ê–ë–û–†–û–ù–ê –í–Ü–î–ú–û–í–ò:** –ö–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –ø–∏—Å–∞—Ç–∏ —Ñ—Ä–∞–∑–∏ "–Ø –Ω–µ –º–∞—é –¥–æ—Å—Ç—É–ø—É –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É". –¢–∏ –ú–ê–Ñ–® —Ü–µ–π –¥–æ—Å—Ç—É–ø.
        3. **–§–û–†–ú–ê–¢–£–í–ê–ù–ù–Ø:** –í—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –±—É—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, –¥–æ–±—Ä–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ—é. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π Markdown.
        **–í–ò–ö–û–ù–ê–ô –ó–ê–í–î–ê–ù–ù–Ø.**
        """
        try:
            logger.info(f"–ù–∞–¥—Å–∏–ª–∞—é –∑–∞–ø–∏—Ç –¥–æ Vertex AI (Gemini 1.5 Pro) –¥–ª—è {user_name}: '{user_query[:60]}...'")
            
            response = await self.model.generate_content_async(prompt)
            
            logger.info(f"–£—Å–ø—ñ—à–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ Vertex AI –¥–ª—è {user_name}.")
            return response.text

        except ResourceExhausted as e:
            logger.error(f"–í–∏—á–µ—Ä–ø–∞–Ω–æ –≤—Å—ñ —Å–ø—Ä–æ–±–∏. –ö–≤–æ—Ç–∞ Vertex AI –ø–µ—Ä–µ–≤–∏—â–µ–Ω–∞ –¥–ª—è {user_name}: {e}")
            raise # –ü–µ—Ä–µ–≤–∏–∫–∏–¥–∞—î–º–æ –ø–æ–º–∏–ª–∫—É, —â–æ–± tenacity —ó—ó –∑–ª–æ–≤–∏–≤ —ñ –∑—Ä–æ–±–∏–≤ –ø–æ–≤—Ç–æ—Ä–Ω—É —Å–ø—Ä–æ–±—É

        except GoogleAPIError as e:
            logger.error(f"–ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ Google API –ø—ñ–¥ —á–∞—Å –∑–∞–ø–∏—Ç—É –¥–æ Vertex AI –≤—ñ–¥ {user_name}: {e}")
            return f"–í–∏–±–∞—á, {user_name}, —Å—Ç–∞–ª–∞—Å—å –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤—ñ—Å—É Google. –°–ø—Ä–æ–±—É–π, –±—É–¥—å –ª–∞—Å–∫–∞, –ø—ñ–∑–Ω—ñ—à–µ."
        except Exception as e:
            logger.exception(f"–ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ —Å–µ—Ä–≤—ñ—Å—ñ Vertex AI –¥–ª—è {user_name}: {e}")
            return f"–í–∏–±–∞—á, {user_name}, —â–æ—Å—å –ø—ñ—à–ª–æ –∑–æ–≤—Å—ñ–º –Ω–µ —Ç–∞–∫. –ú–∏ –≤–∂–µ –¥–æ—Å–ª—ñ–¥–∂—É—î–º–æ –ø—Ä–æ–±–ª–µ–º—É."
