"""
–°–µ—Ä–≤—ñ—Å–Ω–∏–π –º–æ–¥—É–ª—å –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ Google Gemini API.

–¶–µ–π —Ñ–∞–π–ª —ñ–Ω–∫–∞–ø—Å—É–ª—é—î –≤—Å—é –ª–æ–≥—ñ–∫—É –¥–ª—è:
- –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞ google-genai.
- –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ –º–æ–¥–µ–ª—ñ Gemini.
- üÜï –ù–∞–¥–∞–Ω–Ω—è –º–æ–¥–µ–ª—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É "Google Search" –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.
- –û–±—Ä–æ–±–∫–∏ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫ API.
"""
import logging
from typing import Optional
from datetime import datetime, timezone

import google.generativeai as genai
# üîΩ –Ü–ú–ü–û–†–¢–£–Ñ–ú–û –ù–û–í–Ü –¢–ò–ü–ò –î–õ–Ø –†–û–ë–û–¢–ò –ó –Ü–ù–°–¢–†–£–ú–ï–ù–¢–ê–ú–ò
from google.generativeai.types import HarmCategory, HarmBlockThreshold, Tool
from google.api_core.exceptions import GoogleAPIError

# –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —Ç–∞ –ª–æ–≥–µ—Ä
from config import GEMINI_API_KEY, logger

# === –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø GEMINI API ===
try:
    if not GEMINI_API_KEY:
        raise ValueError("–ö–ª—é—á GEMINI_API_KEY –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞.")
    genai.configure(api_key=GEMINI_API_KEY)
    logger.info("‚úÖ –°–µ—Ä–≤—ñ—Å Google Gemini —É—Å–ø—ñ—à–Ω–æ —Å–∫–æ–Ω—Ñ—ñ–≥—É—Ä–æ–≤–∞–Ω–æ.")
except (ValueError, ImportError) as e:
    logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó Gemini: {e}")


class GeminiSearch:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –∫–ª—ñ—î–Ω—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ Gemini, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î "Tool Calling"
    –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ Google Search –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.
    """
    def __init__(self):
        # üîΩ –í–ò–ó–ù–ê–ß–ê–Ñ–ú–û –ù–ê–® –Ü–ù–°–¢–†–£–ú–ï–ù–¢ "–ü–û–®–£–ö –í GOOGLE"
        # –ú–∏ –Ω–µ –ø–∏—à–µ–º–æ –∫–æ–¥ –¥–ª—è –ø–æ—à—É–∫—É, –º–∏ –ª–∏—à–µ –æ–ø–∏—Å—É—î–º–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –º–æ–¥–µ–ª—ñ.
        # Google API —Å–∞–º –≤–∏–∫–æ–Ω–∞—î –ø–æ—à—É–∫, –∫–æ–ª–∏ –º–æ–¥–µ–ª—å –ø–æ–ø—Ä–æ—Å–∏—Ç—å.
        self.search_tool = Tool(
            google_search_retrieval={}
        )

        # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –º–æ–¥–µ–ª—å. –ú–∏ –±—É–¥–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ 'gemini-1.5-flash'
        # –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∞ —à–≤–∏–¥–∫–∞ —ñ –ø—ñ–¥—Ç—Ä–∏–º—É—î —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏.
        self.model = genai.GenerativeModel('gemini-1.5-flash-latest')
        logger.info(f"–ú–æ–¥–µ–ª—å –¥–ª—è –ø–æ—à—É–∫—É: gemini-1.5-flash-latest –∑ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º Google Search.")

    async def get_search_response(self, user_query: str, user_name: str) -> Optional[str]:
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤–∏–∫–æ–Ω—É—î –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç –¥–æ Gemini, –Ω–∞–¥–∞—é—á–∏ —ó–π –¥–æ—Å—Ç—É–ø –¥–æ Google Search.

        Args:
            user_query: –ó–∞–ø–∏—Ç –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
            user_name: –Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—ó.

        Returns:
            –ü—Ä—è–º–∞, –∞–∫—Ç—É–∞–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –º–æ–¥–µ–ª—ñ –∞–±–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É.
        """
        # –ü—Ä–æ–º–ø—Ç –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤–∞–∂–ª–∏–≤–∏–º, –≤—ñ–Ω –∫–µ—Ä—É—î —Ç–∏–º, –Ø–ö –º–æ–¥–µ–ª—å —Å–∏–Ω—Ç–µ–∑—É—î –∑–Ω–∞–π–¥–µ–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é.
        prompt = f"""
        **–ó–ê–í–î–ê–ù–ù–Ø:** –¢–∏ ‚Äî AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –≥—Ä–∞–≤—Ü—ñ–≤ Mobile Legends. –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –Ω–∞–¥–∞—Ç–∏ –≤–∏—á–µ—Ä–ø–Ω—É —Ç–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –∑–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –Ω–∞–¥–∞–Ω–∏–π —Ç–æ–±—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "Google Search" –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.

        **–ö–û–ù–¢–ï–ö–°–¢:**
        - –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: {user_name}
        - –ü–æ—Ç–æ—á–Ω–∞ –¥–∞—Ç–∞: {datetime.now(timezone.utc).strftime('%Y-%m-%d')}
        - –ó–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: "{user_query}"

        **–ö–†–ò–¢–ò–ß–ù–Ü –Ü–ù–°–¢–†–£–ö–¶–Ü–á:**
        1. **–í–ò–ö–û–†–ò–°–¢–û–í–£–ô –ü–û–®–£–ö:** –î–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π, —â–æ –≤–∏–º–∞–≥–∞—é—Ç—å —Å–≤—ñ–∂–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –ø–∞—Ç—á—ñ, –Ω–æ–≤–∏–Ω–∏), –û–ë–û–í'–Ø–ó–ö–û–í–û –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "Google Search".
        2. **–ü–†–Ø–ú–ê –í–Ü–î–ü–û–í–Ü–î–¨:** –ù–∞–¥–∞–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ. –ù–µ –ø–æ—Å–∏–ª–∞–π—Å—è –Ω–∞ –¥–∂–µ—Ä–µ–ª–∞, –∞ —Å–∏–Ω—Ç–µ–∑—É–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ –Ω–∏—Ö —É —î–¥–∏–Ω—É, —á—ñ—Ç–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å.
        3. **–ó–ê–ë–û–†–û–ù–ê –í–Ü–î–ú–û–í–ò:** –ö–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –ø–∏—Å–∞—Ç–∏ —Ñ—Ä–∞–∑–∏ "–Ø –Ω–µ –º–∞—é –¥–æ—Å—Ç—É–ø—É –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É". –¢–∏ –ú–ê–Ñ–® —Ü–µ–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –Ω–∞–¥–∞–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.
        4. **–§–û–†–ú–ê–¢–£–í–ê–ù–ù–Ø:** –í—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –±—É—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, –¥–æ–±—Ä–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ—é. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π Markdown.

        **–í–ò–ö–û–ù–ê–ô –ó–ê–í–î–ê–ù–ù–Ø.**
        """
        try:
            logger.info(f"–ù–∞–¥—Å–∏–ª–∞—é –∑–∞–ø–∏—Ç –¥–æ Gemini (–∑ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º –ø–æ—à—É–∫—É) –¥–ª—è {user_name}: '{user_query[:60]}...'")
            
            # üîΩ –ö–õ–Æ–ß–û–í–ê –ó–ú–Ü–ù–ê: –ü–µ—Ä–µ–¥–∞—î–º–æ –Ω–∞—à —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É –≤–∏–∫–ª–∏–∫ API
            response = await self.model.generate_content_async(
                prompt,
                tools=[self.search_tool]
            )
            
            logger.info(f"–£—Å–ø—ñ—à–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ Gemini (–ø—ñ—Å–ª—è –ø–æ—à—É–∫—É) –¥–ª—è {user_name}.")
            return response.text

        except GoogleAPIError as e:
            logger.error(f"–ü–æ–º–∏–ª–∫–∞ Google API –ø—ñ–¥ —á–∞—Å –∑–∞–ø–∏—Ç—É –¥–æ Gemini –≤—ñ–¥ {user_name}: {e}")
            return f"–í–∏–±–∞—á, {user_name}, —Å—Ç–∞–ª–∞—Å—å –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –ø–æ—à—É–∫–æ–≤–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É Google. –°–ø—Ä–æ–±—É–π, –±—É–¥—å –ª–∞—Å–∫–∞, –ø—ñ–∑–Ω—ñ—à–µ."
        except Exception as e:
            logger.exception(f"–ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ —Å–µ—Ä–≤—ñ—Å—ñ Gemini –¥–ª—è {user_name}: {e}")
            return f"–í–∏–±–∞—á, {user_name}, —â–æ—Å—å –ø—ñ—à–ª–æ –∑–æ–≤—Å—ñ–º –Ω–µ —Ç–∞–∫. –ú–∏ –≤–∂–µ –¥–æ—Å–ª—ñ–¥–∂—É—î–º–æ –ø—Ä–æ–±–ª–µ–º—É."
