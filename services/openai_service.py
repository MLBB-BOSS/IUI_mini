import asyncio
import base64
import html
import json
import logging
import re
from datetime import datetime, timezone, timedelta
from typing import Optional, Dict, Any

import aiohttp
from aiohttp import ClientSession, ClientTimeout

# –õ–æ–≥–µ—Ä —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –≤ config.py —ñ –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π —á–µ—Ä–µ–∑ —ñ–º–ø–æ—Ä—Ç –≤ —ñ–Ω—à–∏—Ö –º–æ–¥—É–ª—è—Ö,
# –∞–ª–µ —è–∫—â–æ —Ü–µ–π —Ñ–∞–π–ª –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ–∫—Ä–µ–º–æ, –∞–±–æ –¥–ª—è –±—ñ–ª—å—à–æ—ó —è–≤–Ω–æ—Å—Ç—ñ, –º–æ–∂–Ω–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –π–æ–≥–æ —Ç–∞–∫:
# logger = logging.getLogger(__name__)
# –£ –Ω–∞—à–æ–º—É –≤–∏–ø–∞–¥–∫—É, –∫–ª–∞—Å MLBBChatGPT —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î —Å–≤—ñ–π class_logger.


# === –ü–†–û–ú–ü–¢–ò ===

PROFILE_SCREENSHOT_PROMPT = """
–¢–∏ ‚Äî –µ–∫—Å–ø–µ—Ä—Ç–Ω–∏–π –∞–Ω–∞–ª—ñ—Ç–∏–∫ –≥—Ä–∏ Mobile Legends: Bang Bang.
–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî —É–≤–∞–∂–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –Ω–∞–¥–∞–Ω–∏–π —Å–∫—Ä—ñ–Ω—à–æ—Ç –ø—Ä–æ—Ñ—ñ–ª—é –≥—Ä–∞–≤—Ü—è.
–í–∏—Ç—è–≥–Ω–∏ –Ω–∞—Å—Ç—É–ø–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é —Ç–∞ –ø–æ–≤–µ—Ä–Ω–∏ —ó—ó –í–ò–ö–õ–Æ–ß–ù–û —É —Ñ–æ—Ä–º–∞—Ç—ñ –≤–∞–ª—ñ–¥–Ω–æ–≥–æ JSON –æ–±'—î–∫—Ç–∞.
–ù–µ –¥–æ–¥–∞–≤–∞–π –∂–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É –¥–æ –∞–±–æ –ø—ñ—Å–ª—è JSON, —Ç—ñ–ª—å–∫–∏ —Å–∞–º JSON.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ —Ç–∞–∫–æ—é:
{
  "game_nickname": "string –∞–±–æ null, —è–∫—â–æ –Ω–µ –≤–∏–¥–Ω–æ",
  "mlbb_id_server": "string —É —Ñ–æ—Ä–º–∞—Ç—ñ 'ID (SERVER)' –∞–±–æ null, —è–∫—â–æ –Ω–µ –≤–∏–¥–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, '123456789 (1234)')",
  "highest_rank_season": "string (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, '–ú—ñ—Ñ—ñ—á–Ω–∞ –°–ª–∞–≤–∞ 267 ‚òÖ', '–ú—ñ—Ñ—ñ—á–Ω–∞ –°–ª–∞–≤–∞ 1111 ‚òÖ') –∞–±–æ null",
  "matches_played": "int –∞–±–æ null",
  "likes_received": "int –∞–±–æ null",
  "location": "string (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 'Ukraine/Dnipropetrovs'k') –∞–±–æ null",
  "squad_name": "string (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 'IS Iron Spirit.') –∞–±–æ null"
}

–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–Ü –Ü–ù–°–¢–†–£–ö–¶–Ü–á –î–õ–Ø –¢–û–ß–ù–û–°–¢–Ü (–í–µ—Ä—Å—ñ—è –ø—Ä–æ–º–ø—Ç—É 3, –≤—Ä–∞—Ö–æ–≤—É—é—á–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –ø–æ–º–∏–ª–∫–∏):
1.  **–ù–∞–π–≤–∏—â–∏–π –†–∞–Ω–≥ –°–µ–∑–æ–Ω—É (Highest Rank Season):** –†–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏–π –ø—ñ–¥ –Ω–∞–ø–∏—Å–æ–º "Highest Rank". –£–≤–∞–∂–Ω–æ –≤–∏—Ç—è–≥—É–π –Ω–∞–∑–≤—É —Ä–∞–Ω–≥—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–ú—ñ—Ñ—ñ—á–Ω–∞ –°–ª–∞–≤–∞", "–õ–µ–≥–µ–Ω–¥–∞") –¢–ê **–¢–û–ß–ù–£ –ö–Ü–õ–¨–ö–Ü–°–¢–¨ –ó–Ü–†–û–ö (‚òÖ) –ê–ë–û –û–ß–û–ö –°–õ–ê–í–ò**. –¶–µ —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è —î –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–ò–ú. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤ –ö–û–ñ–ù–£ —Ü–∏—Ñ—Ä—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, '‚òÖ1111', –∞ –Ω–µ '‚òÖ111').
2.  **–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ú–∞—Ç—á—ñ–≤ (Matches Played) —Ç–∞ –õ–∞–π–∫—ñ–≤ (Likes Received):**
    *   –¶—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –∑–∞–∑–≤–∏—á–∞–π —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ **–í –ù–ò–ñ–ù–Ü–ô –ß–ê–°–¢–ò–ù–Ü** —Å–∫—Ä—ñ–Ω—à–æ—Ç–∞ –ø—Ä–æ—Ñ—ñ–ª—é –≥—Ä–∞–≤—Ü—è, —á–∞—Å—Ç–æ –ø—ñ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ/—Ö–∞—Ä–∏–∑–º–∏/–≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤, —ñ –º–∞—é—Ç—å —á—ñ—Ç–∫—ñ —Ç–µ–∫—Å—Ç–æ–≤—ñ –º—ñ—Ç–∫–∏ **"Matches Played"** —Ç–∞ **"Likes"** (–∞–±–æ —ó—Ö –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç).
    *   **–ù–ï –ü–õ–£–¢–ê–ô** —Ü—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ —ñ–Ω—à–∏–º–∏ —á–∏—Å–ª–∞–º–∏ –Ω–∞ —Å–∫—Ä—ñ–Ω—à–æ—Ç—ñ, —Ç–∞–∫–∏–º–∏ —è–∫ –æ—á–∫–∏ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ (—á–∞—Å—Ç–æ –∑ "k" –Ω–∞ –∫—ñ–Ω—Ü—ñ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "1866.0k"), –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤ ("Visitors") –∞–±–æ –±–∞–ª–∏ —Ö–∞—Ä–∏–∑–º–∏. "Matches Played" —Ç–∞ "Likes" ‚Äì —Ü–µ –æ–∫—Ä–µ–º—ñ, —á—ñ—Ç–∫–æ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ –ø–æ–ª—è.
    *   –¶—ñ —á–∏—Å–ª–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è —î –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–ò–ú–ò. –ë—É–¥—å –ù–ê–î–ó–í–ò–ß–ê–ô–ù–û —É–≤–∞–∂–Ω–∏–º, —â–æ–± —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ –ö–û–ñ–ù–£ —Ü–∏—Ñ—Ä—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ß–∏—Å–ª–∞ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–µ–ª–∏–∫–∏–º–∏.
3.  **ID —Ç–∞ –°–µ—Ä–≤–µ—Ä (mlbb_id_server):**
    *   ID –≥—Ä–∞–≤—Ü—è ‚Äì —Ü–µ —á–∏—Å–ª–æ, —â–æ –∑–∞–∑–≤–∏—á–∞–π –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –±—ñ–ª—è —ñ–∫–æ–Ω–∫–∏, —è–∫–∞ —Å–∏–º–≤–æ–ª—ñ–∑—É—î –ø—Ä–æ—Ñ—ñ–ª—å –∞–±–æ –ª—é–¥–∏–Ω—É (—á–∞—Å—Ç–æ –ø—ñ–¥ –Ω—ñ–∫–Ω–µ–π–º–æ–º).
    *   –ù–æ–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞ ‚Äì —Ü–µ —á–∏—Å–ª–æ, —â–æ —á–∞—Å—Ç–æ –≤–∫–∞–∑—É—î—Ç—å—Å—è –ø–æ—Ä—É—á —ñ–∑ –Ω–∞–ø–∏—Å–æ–º "Server:" (–∞–±–æ –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–æ–º).
    *   –ü–æ–≤–µ—Ä—Ç–∞–π —É —Ñ–æ—Ä–º–∞—Ç—ñ **'ID (SERVER)'** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, '158 (6203)'). –Ø–∫—â–æ –æ–¥–Ω–∞ –∑ —á–∞—Å—Ç–∏–Ω –Ω–µ –≤–∏–¥–Ω–∞, –≤–∫–∞–∑—É–π –Ω–∞—è–≤–Ω—É –∞–±–æ `null` –¥–ª—è –≤—ñ–¥—Å—É—Ç–Ω—å–æ—ó, –∑–±–µ—Ä—ñ–≥–∞—é—á–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, '158 (null)' –∞–±–æ 'null (6203)').
4.  **–ù–∞–∑–≤–∞ –°–∫–≤–∞–¥—É (Squad Name):** –í–∏—Ç—è–≥—É–π –ü–û–í–ù–£ –Ω–∞–∑–≤—É —Å–∫–≤–∞–¥—É, —è–∫ –≤–æ–Ω–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–∞, –≤–∫–ª—é—á–∞—é—á–∏ –ø—Ä–µ—Ñ—ñ–∫—Å–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "GK Geekay Esports"). –Ø–∫—â–æ —Å–∫–≤–∞–¥ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π `null`.
5.  **–õ–æ–∫–∞—Ü—ñ—è (Location):** –Ø–∫—â–æ –ø–æ–ª–µ –¥–ª—è –ª–æ–∫–∞—Ü—ñ—ó –º—ñ—Å—Ç–∏—Ç—å –Ω–∞–ø–∏—Å "No data", "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö" –∞–±–æ –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–∏–π, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π `null`.
6.  **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –î–∞–Ω–∏—Ö –ó–∞–≥–∞–ª–æ–º:** –Ø–∫—â–æ –±—É–¥—å-—è–∫–∞ —ñ–Ω—à–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –≤—ñ–¥—Å—É—Ç–Ω—è –∞–±–æ –Ω–µ—Ä–æ–∑–±—ñ—Ä–ª–∏–≤–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π `null`. –ù–µ –≤–∏–≥–∞–¥—É–π –¥–∞–Ω—ñ.

–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–∏–º —É –≤—Å—ñ—Ö –ø–æ–ª—è—Ö. –û—Å–æ–±–ª–∏–≤—É —É–≤–∞–≥—É –ø—Ä–∏–¥—ñ–ª—è–π –ß–Ü–¢–ö–û–ú–£ –ó–Ü–°–¢–ê–í–õ–ï–ù–ù–Æ –¢–ï–ö–°–¢–û–í–ò–• –ú–Ü–¢–û–ö –∑ —ó—Ö–Ω—ñ–º–∏ —á–∏—Å–ª–æ–≤–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏, –æ—Å–æ–±–ª–∏–≤–æ –¥–ª—è "Matches Played" —Ç–∞ "Likes".
"""

PROFILE_DESCRIPTION_PROMPT_TEMPLATE = """
–¢–∏ ‚Äî —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω–∏–π —Ç–∞ –¥–æ—Ç–µ–ø–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ç–æ—Ä –º–∞—Ç—á—ñ–≤ Mobile Legends, —è–∫–∏–π –≤–º—ñ—î –∑–Ω–∞–π—Ç–∏ —Ä–æ–¥–∑–∏–Ω–∫—É –≤ –∫–æ–∂–Ω–æ–º—É –≥—Ä–∞–≤—Ü–µ–≤—ñ. –¢–≤–æ—è –º–µ—Ç–∞ ‚Äî —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–π (2-5 —Ä–µ—á–µ–Ω—å), –∞–ª–µ —è—Å–∫—Ä–∞–≤–∏–π —Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π "–≤–∞—É-–µ—Ñ–µ–∫—Ç" –æ–ø–∏—Å –¥–ª—è –≥—Ä–∞–≤—Ü—è {user_name}, –±–∞–∑—É—é—á–∏—Å—å –Ω–∞ –¥–∞–Ω–∏—Ö –π–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é. –û–ø–∏—Å –º–∞—î –±—É—Ç–∏ —Å—Ö–æ–∂–∏–º –Ω–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä —Å—Ç—Ä—ñ–º–µ—Ä–∞ –ø—ñ–¥ —á–∞—Å —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó.

–û—Å—å –¥–∞–Ω—ñ –∑ –ø—Ä–æ—Ñ—ñ–ª—é:
- –ù—ñ–∫–Ω–µ–π–º: {game_nickname}
- –ù–∞–π–≤–∏—â–∏–π —Ä–∞–Ω–≥ —Å–µ–∑–æ–Ω—É: {highest_rank_season}
- –ú–∞—Ç—á—ñ–≤ –∑—ñ–≥—Ä–∞–Ω–æ: {matches_played}
- –õ–∞–π–∫—ñ–≤ –æ—Ç—Ä–∏–º–∞–Ω–æ: {likes_received}
- –õ–æ–∫–∞—Ü—ñ—è: {location}
- –°–∫–≤–∞–¥: {squad_name}

–¢–í–û–á –ó–ê–í–î–ê–ù–ù–Ø –î–õ–Ø –°–¢–í–û–†–ï–ù–ù–Ø –£–ù–Ü–ö–ê–õ–¨–ù–û–ì–û –ö–û–ú–ï–ù–¢–ê–†–Ø:
1.  **–ó–Ω–∞–π–¥–∏ "—Ñ—ñ—à–∫—É":** –ù–∞ —á–æ–º—É –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –∞–∫—Ü–µ–Ω—Ç? –¶–µ –º–æ–∂–µ –±—É—Ç–∏:
    *   –í—Ä–∞–∂–∞—é—á–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –º–∞—Ç—á—ñ–≤ –∞–±–æ –ª–∞–π–∫—ñ–≤.
    *   –í–∏—Å–æ–∫–∏–π —Ä–∞–Ω–≥ (–æ—Å–æ–±–ª–∏–≤–æ —è–∫—â–æ —î –∑—ñ—Ä–∫–∏/–æ—á–∫–∏ —Å–ª–∞–≤–∏).
    *   –¶—ñ–∫–∞–≤–∏–π –∞–±–æ –∫—É–º–µ–¥–Ω–∏–π –Ω—ñ–∫–Ω–µ–π–º (–æ–±—ñ–≥—Ä–∞–π –π–æ–≥–æ!).
    *   –ù–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –¥–æ —Å–∫–≤–∞–¥—É (–º–æ–∂–Ω–∞ –ø–æ–∂–∞—Ä—Ç—É–≤–∞—Ç–∏ –ø—Ä–æ –∫–æ–º–∞–Ω–¥–Ω—É —Å–∏–Ω–µ—Ä–≥—ñ—é).
    *   –ù–µ–∑–≤–∏—á–∞–π–Ω–µ –ø–æ—î–¥–Ω–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –º–∞–ª–æ –º–∞—Ç—á—ñ–≤, –∞–ª–µ –≤–∏—Å–æ–∫–∏–π —Ä–∞–Ω–≥).
    *   –ù–∞–≤—ñ—Ç—å –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —è–∫–∏—Ö–æ—Å—å –¥–∞–Ω–∏—Ö –º–æ–∂–Ω–∞ –æ–±—ñ–≥—Ä–∞—Ç–∏ –∑ –≥—É–º–æ—Ä–æ–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–Ω–∞—Å—Ç—ñ–ª—å–∫–∏ –∫—Ä—É—Ç–∏–π, —â–æ –ø—Ä–∏—Ö–æ–≤—É—î —Å–≤–æ—é –ª–æ–∫–∞—Ü—ñ—é!").
2.  **–í–∏–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∫–æ–º–µ–Ω—Ç–∞—Ä—è (–º–æ–∂–µ—à –∫–æ–º–±—ñ–Ω—É–≤–∞—Ç–∏):**
    *   **–ó–∞—Ö–æ–ø–ª–µ–Ω–Ω—è:** "–û–≥–æ, {game_nickname} –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑—Ä–∏–≤–∞—î! {matches_played} –º–∞—Ç—á—ñ–≤ ‚Äì —Ü–µ –∂ —Å–∫—ñ–ª—å–∫–∏ –∫–∞—Ç–æ–∫ –∑–∞—Ç–∞—â–µ–Ω–æ!"
    *   **–ì—É–º–æ—Ä/–Ü—Ä–æ–Ω—ñ—è (–¥—Ä—É–∂–Ω—è):** "–¢–∞–∫-—Ç–∞–∫, {game_nickname}, –±–∞—á—É, —Ç–∏ –Ω–µ —Ç—ñ–ª—å–∫–∏ —Ñ–∞—Ä–º–∏—à –∫—Ä–∏–ø—ñ–≤, –∞ –π –ª–∞–π–∫–∏! {likes_received} ‚Äì —Ü–µ —Å–µ—Ä–π–æ–∑–Ω–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ñ—Å—Ç—å!"
    *   **–ü–æ–≤–∞–≥–∞:** "–ó —Ç–∞–∫–∏–º –ø—Ä–æ—Ñ—ñ–ª–µ–º, —è–∫ —É {game_nickname} ({highest_rank_season}), –∂–∞—Ä—Ç–∏ –≤–±—ñ–∫. –°–ø—Ä–∞–≤–∂–Ω—ñ–π –º–∞–π—Å—Ç–µ—Ä —Å–≤–æ—î—ó —Å–ø—Ä–∞–≤–∏."
    *   **–Ü–Ω—Ç—Ä–∏–≥–∞:** "–¶—ñ–∫–∞–≤–æ, {game_nickname} –∑ {location}, —Å–∫—ñ–ª—å–∫–∏ —â–µ —Ä–µ–∫–æ—Ä–¥—ñ–≤ —Ç–∏ –ø–ª–∞–Ω—É—î—à –ø–æ–±–∏—Ç–∏?"
3.  **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —ñ–≥—Ä–æ–≤–∏–π —Å–ª–µ–Ω–≥ –¥–æ—Ä–µ—á–Ω–æ:** "—Ç–∞—â–µ—Ä", "—ñ–º–±–∞", "—Ñ–∞—Ä–º–∏—Ç—å", "—Ä–æ–∑–Ω–æ—Å–∏—Ç—å –∫–∞—Ç–∫–∏", "–≤ —Ç–æ–ø—ñ", "—Å–∫—ñ–ª–æ–≤–∏–π" —Ç–æ—â–æ. –ê–ª–µ –Ω–µ –ø–µ—Ä–µ–±–æ—Ä—â–∏.
4.  **–£–Ω–∏–∫–∞–π –ø–æ–≤—Ç–æ—Ä–µ–Ω—å:** –Ø–∫—â–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –±—É–ª–∏ –ø—Ä–æ "—Ç–∞—â–µ—Ä–∞", —Å–ø—Ä–æ–±—É–π —ñ–Ω—à–∏–π –ø—ñ–¥—Ö—ñ–¥.
5.  **–ë—É–¥—å –ª–∞–∫–æ–Ω—ñ—á–Ω–∏–º:** 2-5 —Ä–µ—á–µ–Ω—å –º–∞–∫—Å–∏–º—É–º.
6.  **–¢–Ü–õ–¨–ö–ò —Ç–µ–∫—Å—Ç –∫–æ–º–µ–Ω—Ç–∞—Ä—è:** –ë–µ–∑ –ø—Ä–∏–≤—ñ—Ç–∞–Ω—å —Ç–∏–ø—É "–ü—Ä–∏–≤—ñ—Ç, {user_name}!" —ñ –±–µ–∑ Markdown/HTML. –¢—ñ–ª—å–∫–∏ —á–∏—Å—Ç–∏–π —Ç–µ–∫—Å—Ç.

–ü–û–ì–ê–ù–ò–ô –ü–†–ò–ö–õ–ê–î (—à–∞–±–ª–æ–Ω–Ω–æ): "{game_nickname} –∫—Ä—É—Ç–∏–π, –±–∞–≥–∞—Ç–æ –≥—Ä–∞—î, –≤–∏—Å–æ–∫–∏–π —Ä–∞–Ω–≥. –ú–æ–ª–æ–¥–µ—Ü—å!"
–î–û–ë–†–ò–ô –ü–†–ò–ö–õ–ê–î (–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ –¥–ª—è –≥—Ä–∞–≤—Ü—è "–ù—ñ–Ω–¥–∑—è–í—Ç–∞–ø–∫–∞—Ö" –∑ 100 –º–∞—Ç—á—ñ–≤, —Ä–∞–Ω–≥ –ï–ø—ñ–∫):
"–ù—ñ–Ω–¥–∑—è–í—Ç–∞–ø–∫–∞—Ö, —Ç–∏ —Ö–æ—á —ñ –Ω—ñ–Ω–¥–∑—è, –∞–ª–µ —Ç–≤–æ—ó 100 –∫–∞—Ç–æ–∫ –Ω–∞ –ï–ø—ñ–∫—É –≤–∂–µ –Ω–µ —Ç–∞–∫—ñ –π —Ç–∏—Ö—ñ! –ú–∞–±—É–¥—å, —Ç–∞–ø–∫–∏ –¥—ñ–π—Å–Ω–æ —â–∞—Å–ª–∏–≤—ñ. –§–∞—Ä–º–∏—à —Ä–µ—Å–ø–µ–∫—Ç, —Ç–∞–∫ —Ç—Ä–∏–º–∞—Ç–∏!"

–ó—Ä–æ–±–∏ —Ç–∞–∫, —â–æ–± –∫–æ–∂–µ–Ω –≥—Ä–∞–≤–µ—Ü—å –≤—ñ–¥—á—É–≤ —Å–µ–±–µ –æ—Å–æ–±–ª–∏–≤–∏–º!
"""

PLAYER_STATS_PROMPT = """
–¢–∏ ‚Äî –µ–∫—Å–ø–µ—Ä—Ç–Ω–∏–π –∞–Ω–∞–ª—ñ—Ç–∏–∫ —Å–∫—Ä—ñ–Ω—à–æ—Ç—ñ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä–∞–≤—Ü—ñ–≤ –∑ –≥—Ä–∏ Mobile Legends: Bang Bang.
–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî —É–≤–∞–∂–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –Ω–∞–¥–∞–Ω–∏–π —Å–∫—Ä—ñ–Ω—à–æ—Ç –∑—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ "Statistics" (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞) –≥—Ä–∞–≤—Ü—è —Ç–∞ –≤–∏—Ç—è–≥–Ω—É—Ç–∏ –í–°–Ü –¥–æ—Å—Ç—É–ø–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏. –ü–æ–≤–µ—Ä–Ω–∏ –¥–∞–Ω—ñ –í–ò–ö–õ–Æ–ß–ù–û —É —Ñ–æ—Ä–º–∞—Ç—ñ –≤–∞–ª—ñ–¥–Ω–æ–≥–æ JSON –æ–±'—î–∫—Ç–∞. –ù–µ –¥–æ–¥–∞–≤–∞–π –∂–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É –¥–æ –∞–±–æ –ø—ñ—Å–ª—è JSON.

–ó–≤–µ—Ä–Ω–∏ —É–≤–∞–≥—É –Ω–∞ –∞–∫—Ç–∏–≤–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "All Seasons", "Current Season"). –Ø–∫—â–æ –≤–∏–¥–Ω–æ –∫—ñ–ª—å–∫–∞ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤, –≤–∫–∞–∂–∏ —Ç–æ–π, –¥–∞–Ω—ñ —è–∫–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ñ–π —á–∞—Å—Ç–∏–Ω—ñ –µ–∫—Ä–∞–Ω–∞.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ —Ç–∞–∫–æ—é:
{
  "stats_filter_type": "string –∞–±–æ null (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 'All Seasons', 'Current Season')",
  "main_indicators": {
    "matches_played": "int –∞–±–æ null",
    "win_rate": "float –∞–±–æ null (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 48.07, –±–µ–∑ –∑–Ω–∞–∫—É '%')",
    "mvp_count": "int –∞–±–æ null"
  },
  "achievements_left_column": {
    "legendary_count": "int –∞–±–æ null",
    "maniac_count": "int –∞–±–æ null",
    "double_kill_count": "int –∞–±–æ null",
    "most_kills_in_one_game": "int –∞–±–æ null",
    "longest_win_streak": "int –∞–±–æ null",
    "highest_dmg_per_min": "int –∞–±–æ null",
    "highest_gold_per_min": "int –∞–±–æ null"
  },
  "achievements_right_column": {
    "savage_count": "int –∞–±–æ null",
    "triple_kill_count": "int –∞–±–æ null",
    "mvp_loss_count": "int –∞–±–æ null",
    "most_assists_in_one_game": "int –∞–±–æ null",
    "first_blood_count": "int –∞–±–æ null",
    "highest_dmg_taken_per_min": "int –∞–±–æ null"
  },
  "details_panel": {
    "kda_ratio": "float –∞–±–æ null",
    "teamfight_participation_rate": "float –∞–±–æ null (–±–µ–∑ –∑–Ω–∞–∫—É '%')",
    "avg_gold_per_min": "int –∞–±–æ null",
    "avg_hero_dmg_per_min": "int –∞–±–æ null",
    "avg_deaths_per_match": "float –∞–±–æ null",
    "avg_turret_dmg_per_match": "int –∞–±–æ null"
  }
}

–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–Ü –Ü–ù–°–¢–†–£–ö–¶–Ü–á –î–õ–Ø –¢–û–ß–ù–û–°–¢–Ü:
1.  **–ß–∏—Å–ª–æ–≤—ñ –ó–Ω–∞—á–µ–Ω–Ω—è:** –ë—É–¥—å –ù–ê–î–ó–í–ò–ß–ê–ô–ù–û —É–≤–∞–∂–Ω–∏–º –¥–æ –≤—Å—ñ—Ö —á–∏—Å–ª–æ–≤–∏—Ö –∑–Ω–∞—á–µ–Ω—å. –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–π –ö–û–ñ–ù–£ —Ü–∏—Ñ—Ä—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π —ñ –Ω–µ –¥–æ–¥–∞–≤–∞–π –∑–∞–π–≤–∏—Ö —Ü–∏—Ñ—Ä.
2.  **Win Rate —Ç–∞ Teamfight Participation:** –î–ª—è "win_rate" —Ç–∞ "teamfight_participation_rate" –≤–∏—Ç—è–≥—É–π —Ç—ñ–ª—å–∫–∏ —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è (float), –æ–ø—É—Å–∫–∞—é—á–∏ —Å–∏–º–≤–æ–ª '%'. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, "48.07%" –º–∞—î —Å—Ç–∞—Ç–∏ `48.07`.
3.  **–†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –ü–æ–∫–∞–∑–Ω–∏–∫—ñ–≤:**
    *   "main_indicators" (matches, win rate, mvp) –∑–∞–∑–≤–∏—á–∞–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ñ –≤–µ–ª–∏–∫–∏–º–∏ –∫—Ä—É–≥–ª–∏–º–∏ –¥—ñ–∞–≥—Ä–∞–º–∞–º–∏/–ø–æ–∫–∞–∑–Ω–∏–∫–∞–º–∏ —É –≤–µ—Ä—Ö–Ω—ñ–π —á–∞—Å—Ç–∏–Ω—ñ.
    *   "achievements_left_column" —Ç–∞ "achievements_right_column" ‚Äì —Ü–µ —Å–ø–∏—Å–∫–∏ –¥–æ—Å—è–≥–Ω–µ–Ω—å –ø—ñ–¥ –æ—Å–Ω–æ–≤–Ω–∏–º–∏ –ø–æ–∫–∞–∑–Ω–∏–∫–∞–º–∏.
    *   "details_panel" ‚Äì —Ü–µ –ø–æ–∫–∞–∑–Ω–∏–∫–∏, —â–æ –∑–∞–∑–≤–∏—á–∞–π –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –≤ –æ–∫—Ä–µ–º—ñ–π –ø–∞–Ω–µ–ª—ñ –ø—Ä–∞–≤–æ—Ä—É—á –ø—ñ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º "Details" (–î–µ—Ç–∞–ª—ñ).
4.  **–ê–∫—Ç–∏–≤–Ω–∏–π –§—ñ–ª—å—Ç—Ä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:** –í–∏–∑–Ω–∞—á, —è–∫–∏–π —Ñ—ñ–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–Ω–∏–π (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "All Seasons" –∞–±–æ "Current Season", –∑–∞–∑–≤–∏—á–∞–π –≤–∏–¥—ñ–ª–µ–Ω–∏–π –∞–±–æ –ø—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–∏–π) —ñ –≤–∫–∞–∂–∏ –π–æ–≥–æ –≤ –ø–æ–ª—ñ "stats_filter_type".
5.  **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –î–∞–Ω–∏—Ö:** –Ø–∫—â–æ –±—É–¥—å-—è–∫–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫ –Ω–µ –≤–∏–¥–Ω–æ –Ω–∞ —Å–∫—Ä—ñ–Ω—à–æ—Ç—ñ –∞–±–æ –≤—ñ–Ω —è–≤–Ω–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–Ω–∞—á–µ–Ω–Ω—è `null` –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ –ø–æ–ª—è –≤ JSON. –ù–µ –≤–∏–≥–∞–¥—É–π –¥–∞–Ω—ñ.
6.  **–¢–æ—á–Ω—ñ—Å—Ç—å –¢–µ–∫—Å—Ç–æ–≤–∏—Ö –ú—ñ—Ç–æ–∫:** –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑—ñ—Å—Ç–∞–≤–ª—è—î—à —á–∏—Å–ª–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ —ó—Ö–Ω—ñ–º–∏ —Ç–µ–∫—Å—Ç–æ–≤–∏–º–∏ –º—ñ—Ç–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "Legendary", "Savage", "KDA", "Gold/Min").

–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–∏–º. –Ø–∫—ñ—Å—Ç—å –≤–∏—Ç—è–≥–Ω—É—Ç–∏—Ö –¥–∞–Ω–∏—Ö —î –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º.
"""

# –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –æ–ø–∏—Å—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä–∞–≤—Ü—è (–¥–ª—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è)
PLAYER_STATS_DESCRIPTION_PROMPT_TEMPLATE = """
–¢–∏ ‚Äî –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π –∞–Ω–∞–ª—ñ—Ç–∏–∫ —Ç–∞ –∫–æ–º–µ–Ω—Ç–∞—Ç–æ—Ä Mobile Legends, –≤—ñ–¥–æ–º–∏–π —Å–≤–æ—ó–º —É–º—ñ–Ω–Ω—è–º –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ —Ü—ñ–∫–∞–≤—ñ –∞—Å–ø–µ–∫—Ç–∏ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏—Ü—ñ –≥—Ä–∞–≤—Ü—ñ–≤.
–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –Ω–∞–¥–∞–Ω—ñ –¥–∞–Ω—ñ –∑—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä–∞–≤—Ü—è {user_name} —Ç–∞ –Ω–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π (3-6 —Ä–µ—á–µ–Ω—å), –∞–ª–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∏–π —Ç–∞ –∑–∞—Ö–æ–ø–ª—é—é—á–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä.

–û—Å—å –¥–∞–Ω—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä–∞–≤—Ü—è ({stats_filter_type}):
- –ú–∞—Ç—á—ñ–≤ –∑—ñ–≥—Ä–∞–Ω–æ: {matches_played}
- –í—ñ–¥—Å–æ—Ç–æ–∫ –ø–µ—Ä–µ–º–æ–≥: {win_rate}%
- MVP: {mvp_count}
- KDA: {kda_ratio}
- –£—á–∞—Å—Ç—å —É –∫–æ–º–∞–Ω–¥–Ω–∏—Ö –±–æ—è—Ö: {teamfight_participation_rate}%
- –°–µ—Ä–µ–¥–Ω—î –∑–æ–ª–æ—Ç–æ/—Ö–≤: {avg_gold_per_min}
- –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∏—Ö: {legendary_count}, –î–∏–∫—É–Ω—Å—Ç–≤: {savage_count}, –ú–∞–Ω—ñ—è–∫—ñ–≤: {maniac_count}
- –ù–∞–π–±—ñ–ª—å—à–∞ —Å–µ—Ä—ñ—è –ø–µ—Ä–µ–º–æ–≥: {longest_win_streak}
- –ù–∞–π–±—ñ–ª—å—à–µ –≤–±–∏–≤—Å—Ç–≤ –∑–∞ –≥—Ä—É: {most_kills_in_one_game}

–¢–í–û–á –ó–ê–í–î–ê–ù–ù–Ø:
1.  **–ó–Ω–∞–π–¥–∏ "—Ä–æ–¥–∑–∏–Ω–∫—É":** –ù–∞ —á–æ–º—É –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –∞–∫—Ü–µ–Ω—Ç? –¶–µ –º–æ–∂–µ –±—É—Ç–∏:
    *   –í–∏—Å–æ–∫–∏–π –≤—ñ–¥—Å–æ—Ç–æ–∫ –ø–µ—Ä–µ–º–æ–≥ –∞–±–æ KDA.
    *   –í–µ–ª–∏–∫–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –º–∞—Ç—á—ñ–≤, —â–æ —Å–≤—ñ–¥—á–∏—Ç—å –ø—Ä–æ –¥–æ—Å–≤—ñ–¥.
    *   –í—Ä–∞–∂–∞—é—á–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å MVP, Legendary, Savage.
    *   –í–∏—Å–æ–∫–∞ —É—á–∞—Å—Ç—å —É –∫–æ–º–∞–Ω–¥–Ω–∏—Ö –±–æ—è—Ö –∞–±–æ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –∑–æ–ª–æ—Ç–∞/—à–∫–æ–¥–∏.
    *   –¶—ñ–∫–∞–≤–µ —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –±–∞–≥–∞—Ç–æ MVP –ø—Ä–∏ —Å–µ—Ä–µ–¥–Ω—å–æ–º—É –≤—ñ–¥—Å–æ—Ç–∫—É –ø–µ—Ä–µ–º–æ–≥).
2.  **–°—Ç–∏–ª—å –∫–æ–º–µ–Ω—Ç–∞—Ä—è:** –ü–æ–∑–∏—Ç–∏–≤–Ω–∏–π, –ø—ñ–¥–±–∞–¥—å–æ—Ä–ª–∏–≤–∏–π, –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –¥–æ—Ä–µ—á–Ω–æ–≥–æ —ñ–≥—Ä–æ–≤–æ–≥–æ —Å–ª–µ–Ω–≥—É. –ú–æ–∂–µ—à –≤—ñ–¥–∑–Ω–∞—á–∏—Ç–∏ —Å–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏ –≥—Ä–∞–≤—Ü—è.
3.  **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** –ü–æ—á–Ω–∏ –∑ –≤—ñ—Ç–∞–Ω–Ω—è, —è–∫—â–æ –¥–æ—Ä–µ—á–Ω–æ, –∞–±–æ –æ–¥—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥—å –¥–æ —Å—É—Ç—ñ. –ó–∞–≤–µ—Ä—à–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–º –ø–æ–±–∞–∂–∞–Ω–Ω—è–º –∞–±–æ —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è–º.
4.  **–õ–∞–∫–æ–Ω—ñ—á–Ω—ñ—Å—Ç—å:** –£–Ω–∏–∫–∞–π –≤–æ–¥–∏, –≥–æ–≤–æ—Ä–∏ –ø–æ —Å—É—Ç—ñ.
5.  **–¢–Ü–õ–¨–ö–ò —Ç–µ–∫—Å—Ç –∫–æ–º–µ–Ω—Ç–∞—Ä—è:** –ë–µ–∑ Markdown/HTML.

–ü–û–ì–ê–ù–ò–ô –ü–†–ò–ö–õ–ê–î: "–ì—Ä–∞–≤–µ—Ü—å {user_name} –∑—ñ–≥—Ä–∞–≤ {matches_played} –º–∞—Ç—á—ñ–≤. –ô–æ–≥–æ KDA {kda_ratio}."
–î–û–ë–†–ò–ô –ü–†–ò–ö–õ–ê–î: "–û–≥–æ, {user_name}, —Ç–≤–æ—ó {matches_played} –º–∞—Ç—á—ñ–≤ —É —Ä–µ–∂–∏–º—ñ '{stats_filter_type}' –≥–æ–≤–æ—Ä—è—Ç—å —Å–∞–º—ñ –∑–∞ —Å–µ–±–µ! –ó —Ç–∞–∫–∏–º –≤—ñ–Ω—Ä–µ–π—Ç–æ–º {win_rate}% —Ç–∞ {mvp_count} MVP —Ç–∏ —Å–ø—Ä–∞–≤–∂–Ω—è –≥—Ä–æ–∑–∞ —Å–µ—Ä–≤–µ—Ä—É. –ê {savage_count} –¥–∏–∫—É–Ω—Å—Ç–≤ ‚Äì —Ü–µ –ø—Ä–æ—Å—Ç–æ –≤–∏—à–µ–Ω—å–∫–∞ –Ω–∞ —Ç–æ—Ä—Ç—ñ! –ü—Ä–æ–¥–æ–≤–∂—É–π –≤ —Ç–æ–º—É –∂ –¥—É—Å—ñ, –ª–µ–≥–µ–Ω–¥–∞!"

–ó—Ä–æ–±–∏ —Ç–∞–∫, —â–æ–± –≥—Ä–∞–≤–µ—Ü—å –≤—ñ–¥—á—É–≤ —Ü—ñ–Ω–Ω—ñ—Å—Ç—å —Å–≤–æ—î—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!
"""


class MLBBChatGPT:
    """
    –ö–ª–∞—Å –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ OpenAI API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ç–µ–∫—Å—Ç—É —Ç–∞ –∞–Ω–∞–ª—ñ–∑—É –∑–æ–±—Ä–∞–∂–µ–Ω—å.
    –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ –º–æ–¥–µ–ª–µ–π GPT, –æ–±—Ä–æ–±–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π
    —Ç–∞ –Ω–∞–¥–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ–≤ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –∑–æ–±—Ä–∞–∂–µ–Ω—å —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –æ–ø–∏—Å—ñ–≤.
    """
    def __init__(self, api_key: str) -> None:
        """
        –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î –∫–ª—ñ—î–Ω—Ç MLBBChatGPT.

        Args:
            api_key: –ö–ª—é—á –¥–æ—Å—Ç—É–ø—É –¥–æ OpenAI API.
        """
        self.api_key = api_key
        self.session: Optional[ClientSession] = None
        self.class_logger = logging.getLogger(f"{__name__}.{self.__class__.__name__}")

    async def __aenter__(self):
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–µ—Å—ñ—ó aiohttp."""
        self.session = ClientSession(
            timeout=ClientTimeout(total=90), # –ó–±—ñ–ª—å—à–µ–Ω–æ –∑–∞–≥–∞–ª—å–Ω–∏–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –≥–Ω—É—á–∫–æ—Å—Ç—ñ
            headers={"Authorization": f"Bearer {self.api_key}"}
        )
        self.class_logger.debug("Aiohttp —Å–µ—Å—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ —Ç–∞ –≤—ñ–¥–∫—Ä–∏—Ç–æ.")
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è —Å–µ—Å—ñ—ó aiohttp."""
        if self.session and not self.session.closed:
            await self.session.close()
            self.class_logger.debug("Aiohttp —Å–µ—Å—ñ—é –∑–∞–∫—Ä–∏—Ç–æ.")
        if exc_type:
            self.class_logger.error(f"–ü–æ–º–∏–ª–∫–∞ –≤ MLBBChatGPT –ø—ñ–¥ —á–∞—Å –≤–∏—Ö–æ–¥—É –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É: {exc_type} {exc_val}", exc_info=True)

    def _create_smart_prompt(self, user_name: str, user_query: str) -> str:
        """
        –°—Ç–≤–æ—Ä—é—î —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ GPT (/go –∫–æ–º–∞–Ω–¥–∞).
        –í–∫–ª—é—á–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å —Ç–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.
        """
        kyiv_tz = timezone(timedelta(hours=3))
        current_time_kyiv = datetime.now(kyiv_tz)
        current_hour = current_time_kyiv.hour
        greeting = "–î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É" if 5 <= current_hour < 12 else \
            "–î–æ–±—Ä–æ–≥–æ –¥–Ω—è" if 12 <= current_hour < 17 else \
            "–î–æ–±—Ä–æ–≥–æ –≤–µ—á–æ—Ä–∞" if 17 <= current_hour < 22 else "–î–æ–±—Ä–æ—ó –Ω–æ—á—ñ"
        
        # –¢—É—Ç –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤–∞—à –¥–µ—Ç–∞–ª—å–Ω–∏–π —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è /go, —è –π–æ–≥–æ —Å–∫–æ—Ä–æ—Ç–∏–≤ –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥—É,
        # –∞–ª–µ —É –≤–∞—à–æ–º—É –∫–æ–¥—ñ –≤—ñ–Ω –º–∞—î –±—É—Ç–∏ –ø–æ–≤–Ω–∏–º.
        return f"""# –°–ò–°–¢–ï–ú–ê: MLBB –ï–ö–°–ü–ï–†–¢ IUI v2.3 üéÆ
## –ü–†–û–§–Ü–õ–¨ –ê–°–ò–°–¢–ï–ù–¢–ê
–¢–∏ - IUI, AI-–µ–∫—Å–ø–µ—Ä—Ç Mobile Legends Bang Bang... (–ø–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç –≤–∞—à–æ–≥–æ –ø—Ä–æ–º–ø—Ç—É)
## –ö–û–ù–¢–ï–ö–°–¢ –°–ü–Ü–õ–ö–£–í–ê–ù–ù–Ø
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: {user_name}
- –ß–∞—Å: {greeting.lower()} ({current_time_kyiv.strftime('%H:%M')} –∑–∞ –ö–∏—î–≤–æ–º)
... (—Ä–µ—à—Ç–∞ –≤–∞—à–æ–≥–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç—É) ...
## –ó–ê–ü–ò–¢ –í–Ü–î {user_name}: "{user_query}"
–¢–≤–æ—è –µ–∫—Å–ø–µ—Ä—Ç–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–ü–ê–ú'–Ø–¢–ê–ô: –ë–ï–ó –í–ò–ì–ê–î–û–ö, —Ç—ñ–ª—å–∫–∏ —Ñ–∞–∫—Ç–∏—á–Ω—ñ –≥–µ—Ä–æ—ó —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è, –≤–∞–ª—ñ–¥–Ω–∏–π HTML):"""

    def _beautify_response(self, text: str) -> str:
        """
        –§–æ—Ä–º–∞—Ç—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å GPT, –¥–æ–¥–∞—é—á–∏ –µ–º–æ–¥–∑—ñ —Ç–∞ HTML-—Ç–µ–≥–∏, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å HTML.
        –í–∏–ø—Ä–∞–≤–ª—è—î –Ω–µ–∑–∞–∫—Ä–∏—Ç—ñ —Ç–µ–≥–∏.
        """
        self.class_logger.debug(f"Beautify: –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ç–µ–∫—Å—Ç (–ø–µ—Ä—à—ñ 100 —Å–∏–º–≤–æ–ª—ñ–≤): '{text[:100]}'")
        header_emojis = {
            "–∫–∞—Ä—Ç–∏": "üó∫Ô∏è", "–æ–±'—î–∫—Ç—ñ–≤": "üõ°Ô∏è", "—Ç–∞–∫—Ç–∏–∫–∞": "‚öîÔ∏è", "–ø–æ–∑–∏—Ü—ñ—è": "üìç", "–∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è": "üí¨",
            "–≥–µ—Ä–æ—è": "ü¶∏", "–≥–µ—Ä–æ—ó–≤": "ü¶∏‚Äç‚ôÇÔ∏èü¶∏‚Äç‚ôÄÔ∏è", "—Ñ–∞—Ä–º": "üí∞", "—Ä–æ—Ç–∞—Ü—ñ—è": "üîÑ", "–∫–æ–º–∞–Ω–¥–Ω–∞ –≥—Ä–∞": "ü§ù",
            "–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó": "ü§ù", "—Å–∏–Ω–µ—Ä–≥—ñ—è": "‚ú®", "—Ä–∞–Ω–∫": "üèÜ", "—Å—Ç—Ä–∞—Ç–µ–≥—ñ": "üéØ", "–º–µ—Ç–∞": "üî•",
            "–ø–æ—Ç–æ—á–Ω–∞ –º–µ—Ç–∞": "üìä", "–Ω–∞–≤–∏—á–∫–∏": "üìà", "—Ç–∞–π–º–∏–Ω–≥": "‚è∞", "–∫–æ–Ω—Ç—Ä–æ–ª—å": "üéÆ", "–ø—É—à": "‚¨ÜÔ∏è",
            "–ø–æ—Ä–∞–¥–∏": "üí°", "–∫–ª—é—á–æ–≤—ñ –ø–æ—Ä–∞–¥–∏": "üí°"
        }

        def replace_header(match: re.Match) -> str:
            header_text = match.group(1).strip(": ").capitalize()
            best_emoji = "üí°" 
            specific_keys = ["–≥–µ—Ä–æ—ó–≤", "–≥–µ—Ä–æ—è", "–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó", "—Å–∏–Ω–µ—Ä–≥—ñ—è", "–∫–ª—é—á–æ–≤—ñ –ø–æ—Ä–∞–¥–∏", "–ø–æ—Ç–æ—á–Ω–∞ –º–µ—Ç–∞"]
            for key in specific_keys:
                if key in header_text.lower():
                    best_emoji = header_emojis.get(key, best_emoji)
                    break
            else: 
                for key_general, emj in header_emojis.items():
                    if key_general in header_text.lower():
                        best_emoji = emj
                        break
            return f"\n\n{best_emoji} <b>{header_text}</b>:"

        text = re.sub(r"^#{2,3}\s*(.+)", replace_header, text, flags=re.MULTILINE)
        text = re.sub(r"^\s*[\-\*]\s+", "‚Ä¢ ", text, flags=re.MULTILINE)
        text = re.sub(r"^\s*‚Ä¢\s+[\-\*]\s+", "  ‚ó¶ ", text, flags=re.MULTILINE)
        text = re.sub(r"\n{3,}", "\n\n", text)
        
        tags_to_balance = ["b", "i", "code"]
        for tag in tags_to_balance:
            open_tag_pattern = re.compile(re.escape(f"<{tag}>"))
            close_tag_pattern = re.compile(re.escape(f"</{tag}>"))
            open_count = len(open_tag_pattern.findall(text))
            close_count = len(close_tag_pattern.findall(text))

            if open_count > close_count:
                missing_tags = open_count - close_count
                self.class_logger.warning(f"Beautify: –í–∏—è–≤–ª–µ–Ω–æ {missing_tags} –Ω–µ–∑–∞–∫—Ä–∏—Ç–∏—Ö —Ç–µ–≥—ñ–≤ '<{tag}>'. –î–æ–¥–∞—é —ó—Ö –≤ –∫—ñ–Ω–µ—Ü—å.")
                text += (f"</{tag}>" * missing_tags)
            elif close_count > open_count:
                self.class_logger.warning(f"Beautify: –í–∏—è–≤–ª–µ–Ω–æ {close_count - open_count} –∑–∞–π–≤–∏—Ö –∑–∞–∫—Ä–∏–≤–∞—é—á–∏—Ö —Ç–µ–≥—ñ–≤ '</{tag}>'. –°–ø—Ä–æ–±–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–±–µ–∑–ø–µ—á–Ω–æ—é, –∑–∞–ª–∏—à–∞—é —è–∫ —î.")

        self.class_logger.debug(f"Beautify: –¢–µ–∫—Å—Ç –ø—ñ—Å–ª—è –æ–±—Ä–æ–±–∫–∏ (–ø–µ—Ä—à—ñ 100 —Å–∏–º–≤–æ–ª—ñ–≤): '{text[:100]}'")
        return text.strip()

    async def get_response(self, user_name: str, user_query: str) -> str:
        """
        –û—Ç—Ä–∏–º—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ GPT –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∏–π –∑–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–¥–ª—è –∫–æ–º–∞–Ω–¥–∏ /go).

        Args:
            user_name: –Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—ó.
            user_query: –¢–µ–∫—Å—Ç–æ–≤–∏–π –∑–∞–ø–∏—Ç –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

        Returns:
            –í—ñ–¥—Ñ–æ—Ä–º–∞—Ç–æ–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ GPT –∞–±–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É.
        """
        self.class_logger.info(f"–ó–∞–ø–∏—Ç –¥–æ GPT (/go) –≤—ñ–¥ '{user_name}': '{user_query[:100]}...'") # –õ–æ–≥—É—î–º–æ –ª–∏—à–µ —á–∞—Å—Ç–∏–Ω—É –¥–æ–≤–≥–æ–≥–æ –∑–∞–ø–∏—Ç—É
        system_prompt = self._create_smart_prompt(user_name, user_query)
        payload = {
            "model": "gpt-4.1", 
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_query}
            ],
            "max_tokens": 1000, 
            "temperature": 0.65, 
            "top_p": 0.9,      
            "presence_penalty": 0.3, 
            "frequency_penalty": 0.2 
        }
        self.class_logger.debug(f"–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ç–µ–∫—Å—Ç—É –¥–ª—è GPT: temperature={payload['temperature']}, max_tokens={payload['max_tokens']}")
        
        if not self.session or self.session.closed:
            self.class_logger.warning("Aiohttp —Å–µ—Å—ñ—è –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ GPT –±—É–ª–∞ –∑–∞–∫—Ä–∏—Ç–∞ –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—è. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é —Ç–∏–º—á–∞—Å–æ–≤—É —Å–µ—Å—ñ—é.")
            async with ClientSession(timeout=ClientTimeout(total=45), headers={"Authorization": f"Bearer {self.api_key}"}) as temp_session:
                return await self._execute_openai_request(temp_session, payload, user_name)
        else:
            return await self._execute_openai_request(self.session, payload, user_name)

    async def _execute_openai_request(self, session: ClientSession, payload: Dict[str, Any], user_name_escaped: str) -> str:
        """–î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É –¥–æ OpenAI —Ç–∞ –æ–±—Ä–æ–±–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ."""
        try:
            async with session.post(
                "https://api.openai.com/v1/chat/completions", 
                json=payload,
                # –¢–∞–π–º–∞—É—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É, —è–∫—â–æ —Å–µ—Å—ñ—è –º–∞—î –∑–∞–≥–∞–ª—å–Ω–∏–π –±—ñ–ª—å—à–∏–π —Ç–∞–π–º–∞—É—Ç
                # –¢—É—Ç –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ ClientTimeout(total=specific_timeout) —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
            ) as response:
                response.raise_for_status() # –í–∏–∫–∏–Ω–µ HTTPError –¥–ª—è –∫–æ–¥—ñ–≤ 4xx/5xx
                result = await response.json()
                
                content = result.get("choices", [{}])[0].get("message", {}).get("content")
                if not content:
                    self.class_logger.error(f"OpenAI API –ø–æ–º–∏–ª–∫–∞ (—Ç–µ–∫—Å—Ç): –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ–π –∫–æ–Ω—Ç–µ–Ω—Ç - {result}")
                    return f"–í–∏–±–∞—á, {html.escape(user_name_escaped)}, –®–Ü –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å ü§Ø."
                
                self.class_logger.info(f"–°–∏—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ GPT (–ø–µ—Ä—à—ñ 100): '{content[:100]}'")
                return self._beautify_response(content)
        except aiohttp.ClientResponseError as e:
            error_text = await e.response.text() if hasattr(e, 'response') and e.response else str(e)
            self.class_logger.error(f"OpenAI API HTTP –ø–æ–º–∏–ª–∫–∞ (—Ç–µ–∫—Å—Ç): {e.status} - {error_text[:200]}", exc_info=True)
            return f"–í–∏–±–∞—á, {html.escape(user_name_escaped)}, –≤–∏–Ω–∏–∫–ª–∏ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –¥–æ—Å—Ç—É–ø–æ–º –¥–æ –®–Ü üòî (–∫–æ–¥: {e.status})."
        except asyncio.TimeoutError:
            self.class_logger.error(f"OpenAI API Timeout (—Ç–µ–∫—Å—Ç) –¥–ª—è –∑–∞–ø–∏—Ç—É.")
            return f"–í–∏–±–∞—á, {html.escape(user_name_escaped)}, –∑–∞–ø–∏—Ç –¥–æ –®–Ü –∑–∞–π–Ω—è–≤ –∑–∞–±–∞–≥–∞—Ç–æ —á–∞—Å—É ‚è≥."
        except Exception as e:
            self.class_logger.exception(f"–ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ GPT: {e}")
            return f"–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ —Ç–≤—ñ–π –∑–∞–ø–∏—Ç, {html.escape(user_name_escaped)} üòï."

    async def analyze_image_with_vision(self, image_base64: str, prompt: str) -> Optional[Dict[str, Any]]:
        """
        –ê–Ω–∞–ª—ñ–∑—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é OpenAI Vision API (gpt-4o-mini).

        Args:
            image_base64: –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ Base64.
            prompt: –°–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç, —â–æ –≤–∫–∞–∑—É—î –º–æ–¥–µ–ª—ñ, —è–∫—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –≤–∏—Ç—è–≥—Ç–∏.

        Returns:
            –°–ª–æ–≤–Ω–∏–∫ –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª—ñ–∑—É —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON –∞–±–æ —Å–ª–æ–≤–Ω–∏–∫ –∑ –ø–æ–º–∏–ª–∫–æ—é.
        """
        self.class_logger.info(f"–ó–∞–ø–∏—Ç –¥–æ Vision API. –ü—Ä–æ–º–ø—Ç –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑: '{prompt[:70].replace('\n', ' ')}...'")
        headers = {
            "Content-Type": "application/json",
            # "Authorization" –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —Å–µ—Å—ñ—ó
        }
        payload = {
            "model": "gpt-4o-mini", 
            "messages": [
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {"type": "image_url", 
                         "image_url": {"url": f"data:image/jpeg;base64,{image_base64}"}
                        }
                    ]
                }
            ],
            "max_tokens": 2000, # –ó–±—ñ–ª—å—à–µ–Ω–æ –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö —Å–∫—Ä—ñ–Ω—à–æ—Ç—ñ–≤ –∑—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é
            "temperature": 0.2  # –ó–º–µ–Ω—à–µ–Ω–æ –¥–ª—è –±—ñ–ª—å—à–æ—ó —Ç–æ—á–Ω–æ—Å—Ç—ñ –≤–∏–ª—É—á–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
        }
        self.class_logger.debug(f"–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è Vision API: –º–æ–¥–µ–ª—å={payload['model']}, max_tokens={payload['max_tokens']}, temperature={payload['temperature']}")

        current_session = self.session
        temp_session_created = False
        if not current_session or current_session.closed:
            self.class_logger.warning("Aiohttp —Å–µ—Å—ñ—è –¥–ª—è Vision API –±—É–ª–∞ –∑–∞–∫—Ä–∏—Ç–∞ –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—è. –°—Ç–≤–æ—Ä—é—é —Ç–∏–º—á–∞—Å–æ–≤—É —Å–µ—Å—ñ—é.")
            current_session = ClientSession(timeout=ClientTimeout(total=90), headers={"Authorization": f"Bearer {self.api_key}"})
            temp_session_created = True
        
        try:
            async with current_session.post( # type: ignore
                "https://api.openai.com/v1/chat/completions",
                headers=headers, 
                json=payload,
                # –¢–∞–π–º–∞—É—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, ClientTimeout(total=90))
            ) as response:
                return await self._handle_vision_response(response)
        except aiohttp.ClientResponseError as e:
            error_text = await e.response.text() if hasattr(e, 'response') and e.response else str(e)
            self.class_logger.error(f"Vision API HTTP –ø–æ–º–∏–ª–∫–∞: {e.status} - {error_text[:300]}", exc_info=True)
            return {"error": f"–ü–æ–º–∏–ª–∫–∞ Vision API: {e.status}", "details": error_text[:200]}
        except asyncio.TimeoutError:
            self.class_logger.error("Vision API Timeout –ø–æ–º–∏–ª–∫–∞.")
            return {"error": "–ó–∞–ø–∏—Ç –¥–æ Vision API –∑–∞–π–Ω—è–≤ –∑–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ —á–∞—Å—É."}
        except Exception as e:
            self.class_logger.exception(f"–ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –≤–∏–∫–ª–∏–∫—É Vision API: {e}")
            return {"error": f"–ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª—ñ–∑—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: {str(e)}"}
        finally:
            if temp_session_created and current_session and not current_session.closed: # type: ignore
                await current_session.close() # type: ignore
                self.class_logger.debug("–¢–∏–º—á–∞—Å–æ–≤—É —Å–µ—Å—ñ—é –¥–ª—è Vision API –∑–∞–∫—Ä–∏—Ç–æ.")


    async def _handle_vision_response(self, response: aiohttp.ClientResponse) -> Optional[Dict[str, Any]]:
        """
        –û–±—Ä–æ–±–ª—è—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ Vision API, –≤–∏—Ç—è–≥—É—î —Ç–∞ –ø–∞—Ä—Å–∏—Ç—å JSON.
        """
        try:
            response.raise_for_status() # –í–∏–∫–∏–Ω–µ HTTPError –¥–ª—è –∫–æ–¥—ñ–≤ 4xx/5xx
            result = await response.json()
        except aiohttp.ClientResponseError as e: # –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–µ—Ä–≤–µ—Ä–∞
            error_text = await e.response.text() if e.response else str(e)
            self.class_logger.error(f"Vision API HTTP –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: {e.status} - {error_text[:300]}")
            return {"error": f"–ü–æ–º–∏–ª–∫–∞ Vision API: {e.status}", "details": error_text[:200]}
        except aiohttp.ContentTypeError: # –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ JSON
            raw_text_response = await response.text()
            self.class_logger.error(f"Vision API –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ —î JSON. –°—Ç–∞—Ç—É—Å: {response.status}. –í—ñ–¥–ø–æ–≤—ñ–¥—å: {raw_text_response[:300]}")
            return {"error": "Vision API –ø–æ–≤–µ—Ä–Ω—É–ª–æ –Ω–µ JSON –≤—ñ–¥–ø–æ–≤—ñ–¥—å.", "raw_response": raw_text_response}
        except json.JSONDecodeError as e: # –Ø–∫—â–æ result –Ω–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø–∞—Ä—Å–∏—Ç–∏ —è–∫ JSON (–º–∞–ª–æ–π–º–æ–≤—ñ—Ä–Ω–æ –ø—ñ—Å–ª—è response.json())
             self.class_logger.error(f"–ü–æ–º–∏–ª–∫–∞ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è JSON –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ Vision API (–Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω–æ): {e}. –†–µ–∑—É–ª—å—Ç–∞—Ç: {await response.text()}")
             return {"error": "–ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø–∞—Ä—Å–∏—Ç–∏ JSON –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ Vision API (–≤–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞).", "raw_response": await response.text()}


        content = result.get("choices", [{}])[0].get("message", {}).get("content")
        if not content:
            self.class_logger.error(f"Vision API –≤—ñ–¥–ø–æ–≤—ñ–¥—å –±–µ–∑ –∫–æ–Ω—Ç–µ–Ω—Ç—É: {result}")
            return {"error": "Vision API –ø–æ–≤–µ—Ä–Ω—É–ª–æ –ø–æ—Ä–æ–∂–Ω—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å."}

        self.class_logger.info(f"Vision API —Å–∏—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –æ—Ç—Ä–∏–º–∞–Ω–∞ (–ø–µ—Ä—à—ñ 150 —Å–∏–º–≤–æ–ª—ñ–≤): {content[:150].replace('\n', ' ')}")
        
        json_str = content.strip()
        # –°–ø—Ä–æ–±–∞ –∑–Ω–∞–π—Ç–∏ JSON –±–ª–æ–∫, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—ñ–Ω –æ–±—Ä–∞–º–ª–µ–Ω–∏–π ```json ... ``` –∞–±–æ –º–∞—î –∑–∞–π–≤–∏–π —Ç–µ–∫—Å—Ç
        match = re.search(r"```json\s*(\{.*?\})\s*```", json_str, re.DOTALL)
        if match:
            json_str = match.group(1)
        else:
            # –Ø–∫—â–æ –Ω–µ–º–∞—î ```json ```, —à—É–∫–∞—î–º–æ –ø–µ—Ä—à–∏–π '{' —Ç–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π '}'
            start_brace = json_str.find("{")
            end_brace = json_str.rfind("}")
            if start_brace != -1 and end_brace != -1 and end_brace > start_brace:
                json_str = json_str[start_brace : end_brace + 1]
            else:
                self.class_logger.error(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –≤–∞–ª—ñ–¥–Ω–∏–π JSON –±–ª–æ–∫ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ Vision API. –ö–æ–Ω—Ç–µ–Ω—Ç: '{content[:300]}'")
                return {"error": "–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–ª—É—á–∏—Ç–∏ JSON –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ Vision API.", "raw_response": content}
        
        try:
            parsed_json = json.loads(json_str)
            self.class_logger.info(f"Vision API JSON —É—Å–ø—ñ—à–Ω–æ —Ä–æ–∑–ø–∞—Ä—Å–µ–Ω–æ.")
            return parsed_json
        except json.JSONDecodeError as e:
            self.class_logger.error(f"–ü–æ–º–∏–ª–∫–∞ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è JSON –∑ Vision API: {e}. –†—è–¥–æ–∫ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É: '{json_str[:300]}'")
            return {"error": "–ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø–∞—Ä—Å–∏—Ç–∏ JSON –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ Vision API (–ø–æ–º–∏–ª–∫–∞ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è).", "raw_response": content}

    async def get_profile_description(self, user_name: str, profile_data: Dict[str, Any]) -> str:
        """
        –ì–µ–Ω–µ—Ä—É—î –¥—Ä—É–∂–Ω—ñ–π –æ–ø–∏—Å –ø—Ä–æ—Ñ—ñ–ª—é –≥—Ä–∞–≤—Ü—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–∞–Ω–∏—Ö –≤—ñ–¥ Vision API,
        –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –º–æ–¥–µ–ª—å GPT-4.1.
        """
        self.class_logger.info(f"–ó–∞–ø–∏—Ç –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –æ–ø–∏—Å—É –ø—Ä–æ—Ñ—ñ–ª—é –¥–ª—è '{user_name}'.")

        escaped_profile_data = {
            k: html.escape(str(v)) if v is not None else "–ù–µ –≤–∫–∞–∑–∞–Ω–æ" 
            for k, v in profile_data.items()
        }

        system_prompt_text = PROFILE_DESCRIPTION_PROMPT_TEMPLATE.format(
            user_name=html.escape(user_name), 
            game_nickname=escaped_profile_data.get("game_nickname", "–ù–µ –≤–∫–∞–∑–∞–Ω–æ"),
            highest_rank_season=escaped_profile_data.get("highest_rank_season", "–ù–µ –≤–∫–∞–∑–∞–Ω–æ"),
            matches_played=escaped_profile_data.get("matches_played", "N/A"),
            likes_received=escaped_profile_data.get("likes_received", "N/A"),
            location=escaped_profile_data.get("location", "–ù–µ –≤–∫–∞–∑–∞–Ω–æ"),
            squad_name=escaped_profile_data.get("squad_name", "–ù–µ–º–∞—î"),
        )
        payload = {
            "model": "gpt-4.1", 
            "messages": [{"role": "system", "content": system_prompt_text}],
            "max_tokens": 300, 
            "temperature": 0.7, 
            "top_p": 0.9,
            "presence_penalty": 0.2,
            "frequency_penalty": 0.2
        }
        self.class_logger.debug(f"–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è –æ–ø–∏—Å—É –ø—Ä–æ—Ñ—ñ–ª—é: temp={payload['temperature']}, max_tokens={payload['max_tokens']}")

        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç—É –∂ –ª–æ–≥—ñ–∫—É –¥–ª—è —Å–µ—Å—ñ—ó, —â–æ —ñ –≤ get_response
        if not self.session or self.session.closed:
            self.class_logger.warning("Aiohttp —Å–µ—Å—ñ—è –¥–ª—è –æ–ø–∏—Å—É –ø—Ä–æ—Ñ—ñ–ª—é –±—É–ª–∞ –∑–∞–∫—Ä–∏—Ç–∞ –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—è. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é —Ç–∏–º—á–∞—Å–æ–≤—É —Å–µ—Å—ñ—é.")
            async with ClientSession(timeout=ClientTimeout(total=30), headers={"Authorization": f"Bearer {self.api_key}"}) as temp_session:
                return await self._execute_openai_request(temp_session, payload, user_name) # –ü–æ—Ç—Ä—ñ–±–Ω–æ –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ _execute_openai_request –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π
        else:
            # –ü–æ—Ç—Ä—ñ–±–Ω–æ –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ _execute_openai_request –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π, –æ—Å–∫—ñ–ª—å–∫–∏ _beautify_response —Ç—É—Ç –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω
            # –ü–æ–∫–∏ —â–æ –∑–∞–ª–∏—à—É —Ç–∞–∫, –∞–ª–µ —Ü–µ –ø–æ—Ç—Ä–µ–±—É—î —É–≤–∞–≥–∏, —è–∫—â–æ _beautify_response –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è —Ü—å–æ–≥–æ –≤–∏–ø–∞–¥–∫—É
            # –ê–±–æ, —è–∫—â–æ –æ–ø–∏—Å –º–∞—î –±—É—Ç–∏ —á–∏—Å—Ç–∏–º —Ç–µ–∫—Å—Ç–æ–º, —Ç–æ _beautify_response –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏.
            # –ü—Ä–æ–º–ø—Ç PROFILE_DESCRIPTION_PROMPT_TEMPLATE –ø—Ä–æ—Å–∏—Ç—å "–¢–Ü–õ–¨–ö–ò —Ç–µ–∫—Å—Ç –∫–æ–º–µ–Ω—Ç–∞—Ä—è... –ë–µ–∑ Markdown/HTML."
            # –¢–æ–º—É _beautify_response —Ç—É—Ç –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω. –°—Ç–≤–æ—Ä–∏–º–æ –æ–∫—Ä–µ–º–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —Ü—å–æ–≥–æ.
            return await self._execute_description_request(self.session, payload, user_name)


    async def _execute_description_request(self, session: ClientSession, payload: Dict[str, Any], user_name_escaped: str) -> str:
        """–î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –æ–ø–∏—Å—ñ–≤ (–±–µ–∑ _beautify_response)."""
        try:
            async with session.post(
                "https://api.openai.com/v1/chat/completions", 
                json=payload,
            ) as response:
                response.raise_for_status()
                result = await response.json()
                
                content = result.get("choices", [{}])[0].get("message", {}).get("content")
                if not content:
                    self.class_logger.error(f"OpenAI API –ø–æ–º–∏–ª–∫–∞ (–æ–ø–∏—Å): –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ–π –∫–æ–Ω—Ç–µ–Ω—Ç - {result}")
                    return f"<i>–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ–ø–∏—Å –≤—ñ–¥ –®–Ü –¥–ª—è {html.escape(user_name_escaped)}.</i>"
                
                self.class_logger.info(f"–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –æ–ø–∏—Å: '{content[:100]}'")
                return content.strip() # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —á–∏—Å—Ç–∏–π —Ç–µ–∫—Å—Ç
        except aiohttp.ClientResponseError as e:
            error_text = await e.response.text() if hasattr(e, 'response') and e.response else str(e)
            self.class_logger.error(f"OpenAI API HTTP –ø–æ–º–∏–ª–∫–∞ (–æ–ø–∏—Å): {e.status} - {error_text[:200]}", exc_info=True)
            return f"<i>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –æ–ø–∏—Å –¥–ª—è {html.escape(user_name_escaped)} (–∫–æ–¥: {e.status}).</i>"
        except asyncio.TimeoutError:
            self.class_logger.error(f"OpenAI API Timeout (–æ–ø–∏—Å) –¥–ª—è: '{user_name_escaped}'")
            return f"<i>–û–ø–∏—Å –¥–ª—è {html.escape(user_name_escaped)} –≥–µ–Ω–µ—Ä—É–≤–∞–≤—Å—è –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ...</i>"
        except Exception as e:
            self.class_logger.exception(f"–ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ (–æ–ø–∏—Å) –¥–ª—è '{user_name_escaped}': {e}")
            return f"<i>–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –æ–ø–∏—Å—É –¥–ª—è {html.escape(user_name_escaped)}.</i>"

    # async def get_player_stats_description(self, user_name: str, stats_data: Dict[str, Any]) -> str:
    #     """
    #     (–ú–∞–π–±—É—Ç–Ω—è —Ñ—É–Ω–∫—Ü—ñ—è) –ì–µ–Ω–µ—Ä—É—î —Ç–µ–∫—Å—Ç–æ–≤–∏–π –æ–ø–∏—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä–∞–≤—Ü—è.
    #     """
    #     self.class_logger.info(f"–ó–∞–ø–∏—Ç –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –æ–ø–∏—Å—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è '{user_name}'.")
    #     # –¢—É—Ç –±—É–¥–µ –ª–æ–≥—ñ–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è stats_data –¥–ª—è PLAYER_STATS_DESCRIPTION_PROMPT_TEMPLATE
    #     # —Ç–∞ –≤–∏–∫–ª–∏–∫ _execute_description_request
    #     # ...
    #     # –ü—Ä–∏–∫–ª–∞–¥:
    #     # main_ind = stats_data.get("main_indicators", {})
    #     # details_p = stats_data.get("details_panel", {})
    #     # ach_left = stats_data.get("achievements_left_column", {})
    #     # ach_right = stats_data.get("achievements_right_column", {})

    #     # system_prompt_text = PLAYER_STATS_DESCRIPTION_PROMPT_TEMPLATE.format(
    #     #     user_name=html.escape(user_name),
    #     #     stats_filter_type=html.escape(str(stats_data.get('stats_filter_type', 'N/A'))),
    #     #     matches_played=main_ind.get('matches_played', 'N/A'),
    #     #     win_rate=main_ind.get('win_rate', 'N/A'),
    #     #     mvp_count=main_ind.get('mvp_count', 'N/A'),
    #     #     kda_ratio=details_p.get('kda_ratio', 'N/A'),
    #     #     teamfight_participation_rate=details_p.get('teamfight_participation_rate', 'N/A'),
    #     #     avg_gold_per_min=details_p.get('avg_gold_per_min', 'N/A'),
    #     #     legendary_count=ach_left.get('legendary_count', 'N/A'),
    #     #     savage_count=ach_right.get('savage_count', 'N/A'),
    #     #     maniac_count=ach_left.get('maniac_count', 'N/A'),
    #     #     longest_win_streak=ach_left.get('longest_win_streak', 'N/A'),
    #     #     most_kills_in_one_game=ach_left.get('most_kills_in_one_game', 'N/A')
    #     # )
    #     # payload = { ... model: "gpt-4.1" ... }
    #     # return await self._execute_description_request(self.session, payload, user_name)
    #     return "<i>–û–ø–∏—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä–∞–≤—Ü—è —â–µ –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ.</i>"
