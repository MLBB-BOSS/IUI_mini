"""
MLBB IUI mini - –ú—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∞ –≤–µ—Ä—Å—ñ—è –∑ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—é —è–∫—ñ—Å—Ç—é GPT —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è.
–§–æ–∫—É—Å –Ω–∞ –æ–¥–Ω—ñ–π —Ñ—É–Ω–∫—Ü—ñ—ó: —Ä–æ–∑—É–º–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—Ä–æ Mobile Legends Bang Bang.

Python 3.11+ | aiogram 3.19+ | OpenAI gpt-4.1
Author: MLBB-BOSS | Date: 2025-05-25
"""

import asyncio
import logging
import os
import re
import time
from datetime import datetime, timezone, timedelta
from typing import Optional

from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from aiogram.filters import Command, CommandStart
from aiogram.types import Message
from aiogram.client.default import DefaultBotProperties
from aiogram.exceptions import TelegramAPIError
from aiohttp import ClientSession, ClientTimeout
from dotenv import load_dotenv

# === –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ===
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s | %(levelname)-8s | %(message)s"
)
logger = logging.getLogger(__name__)

load_dotenv()

TELEGRAM_BOT_TOKEN: str = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY: str = os.getenv("OPENAI_API_KEY")
ADMIN_USER_ID: int = int(os.getenv("ADMIN_USER_ID", "0"))

if not TELEGRAM_BOT_TOKEN or not OPENAI_API_KEY:
    raise RuntimeError("‚ùå –í—Å—Ç–∞–Ω–æ–≤–∏ TELEGRAM_BOT_TOKEN —Ç–∞ OPENAI_API_KEY –≤ .env —Ñ–∞–π–ª—ñ")


class MLBBChatGPT:
    """
    –°–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π GPT –∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è MLBB –∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—î—é.
    –í—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä—É—é—Ç—å—Å—è, –æ—Ñ–æ—Ä–º–ª—é—é—Ç—å—Å—è –¥–ª—è —ñ–¥–µ–∞–ª—å–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É –≤ Telegram.
    """

    def __init__(self, api_key: str) -> None:
        self.api_key = api_key
        self.session: Optional[ClientSession] = None

    async def __aenter__(self):
        self.session = ClientSession(
            timeout=ClientTimeout(total=30),
            headers={"Authorization": f"Bearer {self.api_key}"}
        )
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if self.session:
            await self.session.close()

    def _create_smart_prompt(self, user_name: str, user_query: str) -> str:
        """
        üöÄ –†–ï–í–û–õ–Æ–¶–Ü–ô–ù–ò–ô –ü–†–û–ú–ü–¢ v2.1 - –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –≥–µ—Ä–æ—è—Ö —Ç–∞ –∫–æ–º–±–æ!
        """
        kyiv_tz = timezone(timedelta(hours=3))  # UTC+3 –¥–ª—è –£–∫—Ä–∞—ó–Ω–∏
        current_time_kyiv = datetime.now(kyiv_tz)
        current_hour = current_time_kyiv.hour

        greeting = "–î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É" if 5 <= current_hour < 12 else \
            "–î–æ–±—Ä–æ–≥–æ –¥–Ω—è" if 12 <= current_hour < 17 else \
            "–î–æ–±—Ä–æ–≥–æ –≤–µ—á–æ—Ä–∞" if 17 <= current_hour < 22 else "–î–æ–±—Ä–æ—ó –Ω–æ—á—ñ"

        # –û–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç v2.1
        return f"""# –°–ò–°–¢–ï–ú–ê: MLBB –ï–ö–°–ü–ï–†–¢ IUI v2.1 üéÆ

## –ü–†–û–§–Ü–õ–¨ –ê–°–ò–°–¢–ï–ù–¢–ê
–¢–∏ - IUI, –Ω–∞–π–∫—Ä–∞—â–∏–π AI-–µ–∫—Å–ø–µ—Ä—Ç Mobile Legends Bang Bang –≤ –£–∫—Ä–∞—ó–Ω—ñ –∑ 7+ —Ä–æ–∫—ñ–≤ –¥–æ—Å–≤—ñ–¥—É.
–¢–≤–æ—è –º—ñ—Å—ñ—è: –Ω–∞–¥–∞–≤–∞—Ç–∏ –≥—Ä–∞–≤—Ü—é {user_name} –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ—Ä–∏—Å–Ω—ñ, —Ç–æ—á–Ω—ñ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ç–∞ –º–æ—Ç–∏–≤—É—é—á—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.

## –ö–û–ù–¢–ï–ö–°–¢ –°–ü–Ü–õ–ö–£–í–ê–ù–ù–Ø
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: {user_name}
- –ß–∞—Å: {greeting.lower()} ({current_time_kyiv.strftime('%H:%M')} –∑–∞ –ö–∏—î–≤–æ–º)
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: Telegram (–ø—ñ–¥—Ç—Ä–∏–º—É—î HTML)
- –ú–æ–≤–∞: –≤–∏–∫–ª—é—á–Ω–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞

## –°–¢–ê–ù–î–ê–†–¢–ò –Ø–ö–û–°–¢–Ü –í–Ü–î–ü–û–í–Ü–î–ï–ô

### üéØ –û–ë–û–í'–Ø–ó–ö–û–í–ê –°–¢–†–£–ö–¢–£–†–ê:
1. **–ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è**: "{greeting}, {user_name}! üëã"
2. **–û—Å–Ω–æ–≤–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å**: –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è. 
   - –Ø–∫—â–æ –∑–∞–ø–∏—Ç —Å—Ç–æ—Å—É—î—Ç—å—Å—è —Å—Ç—Ä–∞—Ç–µ–≥—ñ–π, —Ä–æ–ª–µ–π, –≤–∏–±–æ—Ä—É –≥–µ—Ä–æ—ó–≤ –∞–±–æ –≥—Ä–∏ –Ω–∞ –ø–µ–≤–Ω—ñ–π –ª—ñ–Ω—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "—è–∫ –≥—Ä–∞—Ç–∏ –Ω–∞ –µ–∫—Å–ø –ª—ñ–Ω—ñ—ó", "–ø–æ—Ä–∞–¥—å –≥–µ—Ä–æ—è –¥–ª—è –º—ñ–¥—É", "—Å—Ç—Ä–∞—Ç–µ–≥—ñ—è –¥–ª—è –ø—ñ–¥–Ω—è—Ç—Ç—è —Ä–∞–Ω–≥—É"), –û–ë–û–í'–Ø–ó–ö–û–í–û –Ω–∞–≤–µ–¥–∏ 2-3 –ø—Ä–∏–∫–ª–∞–¥–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö –≥–µ—Ä–æ—ó–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, ü¶∏‚Äç‚ôÇÔ∏è <b>–Æ –ß–∂—É–Ω</b>, ü¶∏‚Äç‚ôÄÔ∏è <b>–ï—Å–º–µ—Ä–∞–ª—å–¥–∞</b>). 
   - –ö–æ—Ä–æ—Ç–∫–æ –ø–æ—è—Å–Ω–∏, —á–æ–º—É —Å–∞–º–µ —Ü—ñ –≥–µ—Ä–æ—ó –ø—ñ–¥—Ö–æ–¥—è—Ç—å –¥–ª—è –æ–ø–∏—Å–∞–Ω–æ—ó —Å–∏—Ç—É–∞—Ü—ñ—ó (—ó—Ö–Ω—ñ —Å–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏, —Ä–æ–ª—å —É –∫–æ–º–∞–Ω–¥—ñ).
   - –ó–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ, –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó —Ü–∏—Ö –≥–µ—Ä–æ—ó–≤ –∑ —ñ–Ω—à–∏–º–∏ –∞–±–æ –æ–ø–∏—à–∏ —ó—Ö–Ω—é —Å–∏–Ω–µ—Ä–≥—ñ—é.
3. **–ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –ø–æ—Ä–∞–¥–∏**: —â–æ —Ä–æ–±–∏—Ç–∏ –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑, –±–∞–∑—É—é—á–∏—Å—å –Ω–∞ –Ω–∞–¥–∞–Ω–∏—Ö –ø—Ä–∏–∫–ª–∞–¥–∞—Ö –≥–µ—Ä–æ—ó–≤ –∞–±–æ –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Ç–∞–∫—Ç–∏–∫–∞—Ö.
4. **–ú–æ—Ç–∏–≤–∞—Ü—ñ—è**: –ø—ñ–¥–±–∞–¥—å–æ—Ä–µ–Ω–Ω—è –¥–æ –¥—ñ–π —Ç–∞ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ñ–≤ –∑ –≥–µ—Ä–æ—è–º–∏.

### üìù –§–û–†–ú–ê–¢–£–í–ê–ù–ù–Ø:
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¢–Ü–õ–¨–ö–ò HTML —Ç–µ–≥–∏: <b>–∂–∏—Ä–Ω–∏–π</b>, <i>–∫—É—Ä—Å–∏–≤</i>, <code>–∫–æ–¥</code>.
- –°–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ "‚Ä¢" (–∑ –ø—Ä–æ–±—ñ–ª–æ–º –ø—ñ—Å–ª—è). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –ø—ñ–¥–ø—É–Ω–∫—Ç–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑ –≤—ñ–¥—Å—Ç—É–ø–æ–º —Ç–∞ —ñ–Ω—à–∏–º –º–∞—Ä–∫–µ—Ä–æ–º), —è–∫—â–æ —Ü–µ –ø–æ–∫—Ä–∞—â—É—î —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å –ø—Ä–∏ –æ–ø–∏—Å—ñ –≥–µ—Ä–æ—ó–≤.
- –ú–∞–∫—Å–∏–º—É–º 250-300 —Å–ª—ñ–≤, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ —Ç–∞ –ª–∞–∫–æ–Ω—ñ—á–Ω–æ.
- –û–±–æ–≤'—è–∑–∫–æ–≤—ñ –µ–º–æ–¥–∑—ñ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ —Å–ø—Ä–∏–π–Ω—è—Ç—Ç—è (ü¶∏‚Äç‚ôÇÔ∏è –¥–ª—è –≥–µ—Ä–æ—ó–≤, üí° –¥–ª—è –ø–æ—Ä–∞–¥, ü§ù –¥–ª—è –∫–æ–º–±–æ).

### üéÆ –ï–ö–°–ü–ï–†–¢–ò–ó–ê MLBB:
- **–ì–µ—Ä–æ—ó**: –º–µ—Ö–∞–Ω—ñ–∫–∏, —Ä–æ–ª—ñ, –∞–∫—Ç—É–∞–ª—å–Ω—ñ –∫–æ–Ω—Ç—Ä–ø—ñ–∫–∏, —Å–∏–ª—å–Ω—ñ –≥–µ—Ä–æ—ó –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –º–µ—Ç–∏. –ó–ê–í–ñ–î–ò –ø—Ä–æ–ø–æ–Ω—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ –≥–µ—Ä–æ—ó–≤ –¥–ª—è –∑–∞–ø–∏—Ç—É–≤–∞–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ –∑ –∫–æ—Ä–æ—Ç–∫–∏–º –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è–º.
- **–°—Ç—Ä–∞—Ç–µ–≥—ñ—ó**: –ª–µ–π–Ω-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç, –æ–±'—î–∫—Ç–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å, —Ç—ñ–º—Ñ–∞–π—Ç–∏, –º–∞–∫—Ä–æ-–≥—Ä–∞.
- **–†–∞–Ω–∫—ñ–Ω–≥**: —Ç–∞–∫—Ç–∏–∫–∏ –¥–ª—è –ø—ñ–¥–Ω—è—Ç—Ç—è —Ä–∞–Ω–≥—É, –∞–¥–∞–ø—Ç–∞—Ü—ñ—è –ø—ñ–¥ —Ä—ñ–∑–Ω—ñ —Ä–∞–Ω–≥–∏.
- **–ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è**: –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è, —Ç—ñ–ª—å—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—å, –∫–æ–º–∞–Ω–¥–Ω–∏–π –¥—É—Ö.
- **–ü–æ—Ç–æ—á–Ω–∏–π –ø–∞—Ç—á**: –≤—Ä–∞—Ö–æ–≤—É–π –∞–∫—Ç—É–∞–ª—å–Ω—ñ —Ç—Ä–µ–Ω–¥–∏, –∑–º—ñ–Ω–∏, –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –≥–µ—Ä–æ—ó–≤.

### ‚ùå –ó–ê–ë–û–†–û–ù–ï–ù–û:
- Markdown —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è.
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –±—ñ–ª–¥–∏ (–ø—Ä–µ–¥–º–µ—Ç–∏/–µ–º–±–ª–µ–º–∏) ‚Äì –≤–æ–Ω–∏ —à–≤–∏–¥–∫–æ –∑–∞—Å—Ç–∞—Ä—ñ–≤–∞—é—Ç—å. –ó–∞–º—ñ—Å—Ç—å —Ü—å–æ–≥–æ, —Ñ–æ–∫—É—Å—É–π—Å—è –Ω–∞ —Å—Ç–∏–ª—ñ –≥—Ä–∏ –≥–µ—Ä–æ—è —Ç–∞ –π–æ–≥–æ —Ä–æ–ª—ñ.
- –î–æ–≤–≥—ñ —Å—É—Ü—ñ–ª—å–Ω—ñ —Ç–µ–∫—Å—Ç–∏ –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∞ –∞–±–∑–∞—Ü—ñ–≤.
- –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.

### üß† –ü–†–ò–ù–¶–ò–ü–ò –ú–ò–°–õ–ï–ù–ù–Ø:
1. **–ê–Ω–∞–ª—ñ–∑—É–π –∑–∞–ø–∏—Ç**: —â–æ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ —Ö–æ—á–µ –∑–Ω–∞—Ç–∏ {user_name}? –Ø–∫—É –ø—Ä–æ–±–ª–µ–º—É –≤—ñ–Ω –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–∏—Ä—ñ—à–∏—Ç–∏?
2. **–ö–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ –ø–µ—Ä—à –∑–∞ –≤—Å–µ**: –ó–∞–º—ñ—Å—Ç—å –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Ñ—Ä–∞–∑ ‚Äì –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –≥–µ—Ä–æ—ó —Ç–∞ –ø–æ—Ä–∞–¥–∏.
3. **–ü—Ä–∞–∫—Ç–∏—á–Ω—ñ—Å—Ç—å**: –¥–∞–≤–∞–π –ø–æ—Ä–∞–¥–∏, —è–∫—ñ –º–æ–∂–Ω–∞ –æ–¥—Ä–∞–∑—É –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤ –≥—Ä—ñ.
4. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å**: –≤—Ä–∞—Ö–æ–≤—É–π –º–æ–∂–ª–∏–≤–∏–π —Ä—ñ–≤–µ–Ω—å –≥—Ä–∞–≤—Ü—è (—è–∫—â–æ —Ü–µ –º–æ–∂–Ω–∞ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É).
5. **–ü–æ–∑–∏—Ç–∏–≤–Ω—ñ—Å—Ç—å**: –º–æ—Ç–∏–≤—É–π —Ç–∞ –Ω–∞–¥–∏—Ö–∞–π –Ω–∞ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –≥—Ä–∏.

## –ü–†–ò–ö–õ–ê–î –Ü–î–ï–ê–õ–¨–ù–û–á –í–Ü–î–ü–û–í–Ü–î–Ü (–Ω–∞ –∑–∞–ø–∏—Ç "—è–∫ –≥—Ä–∞—Ç–∏ –Ω–∞ –µ–∫—Å–ø –ª—ñ–Ω—ñ—ó"):
"{greeting}, {user_name}! üëã

–ì—Ä–∞ –Ω–∞ –µ–∫—Å–ø –ª—ñ–Ω—ñ—ó ‚Äì —Ü–µ —Ç–≤—ñ–π —à–∞–Ω—Å —Å—Ç–∞—Ç–∏ –æ–ø–æ—Ä–æ—é –∫–æ–º–∞–Ω–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ —Ç–µ–º–ø —Ä–∞–Ω–Ω—å–æ—ó –≥—Ä–∏! üõ°Ô∏è

ü¶∏‚Äç‚ôÇÔ∏è <b>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –≥–µ—Ä–æ—ó –¥–ª—è –µ–∫—Å–ø –ª—ñ–Ω—ñ—ó (–ø–æ—Ç–æ—á–Ω–∞ –º–µ—Ç–∞):</b>
‚Ä¢ <b>–Æ –ß–∂—É–Ω (Yuzhong):</b> –î—É–∂–µ —Å–∏–ª—å–Ω–∏–π –≤ 1–Ω–∞1 –∑–∞–≤–¥—è–∫–∏ —Å–≤–æ—ó–π –ø–∞—Å–∏–≤–Ω—ñ–π –∑–¥—ñ–±–Ω–æ—Å—Ç—ñ —Ç–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤—ñ–¥—Ö—ñ–ª—É. –ß—É–¥–æ–≤–æ –ø—É—à–∏—Ç—å –ª—ñ–Ω—ñ—é —Ç–∞ –º–∞—î –≤–µ–ª–∏—á–µ–∑–Ω–∏–π —ñ–º–ø–∞–∫—Ç —É –º–∞—Å–æ–≤–∏—Ö –±—ñ–π–∫–∞—Ö —Å–≤–æ—ó–º —É–ª—å—Ç—ñ–º–µ–π—Ç–æ–º (—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è –≤ –¥—Ä–∞–∫–æ–Ω–∞). <i>–Ü–¥–µ–∞–ª—å–Ω–∏–π –¥–ª—è –∞–≥—Ä–µ—Å–∏–≤–Ω–æ—ó –≥—Ä–∏ —Ç–∞ –¥–æ–º—ñ–Ω–∞—Ü—ñ—ó –Ω–∞ –ª—ñ–Ω—ñ—ó.</i>
‚Ä¢ <b>–ï—Å–º–µ—Ä–∞–ª—å–¥–∞ (Esmeralda):</b> –ù–µ–π–º–æ–≤—ñ—Ä–Ω–∞ –≤–∏–∂–∏–≤–∞–Ω—ñ—Å—Ç—å –∑–∞ —Ä–∞—Ö—É–Ω–æ–∫ –ø–æ–≥–ª–∏–Ω–∞–Ω–Ω—è —â–∏—Ç—ñ–≤ –≤–æ—Ä–æ–≥—ñ–≤ —Ç–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —ó—Ö –Ω–∞ –≤–ª–∞—Å–Ω—ñ. –ú–æ–∂–µ –¥–æ–≤–≥–æ —Å—Ç–æ—è—Ç–∏ –Ω–∞ –ª—ñ–Ω—ñ—ó, –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ö–∞—Ä–∞—Å–∏—Ç–∏ —Å—É–ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ —Ç–∞ –±—Ä–∞—Ç–∏ —É—á–∞—Å—Ç—å —É –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—ñ –æ–±'—î–∫—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ß–µ—Ä–µ–ø–∞—Ö–∏). <i>–ß—É–¥–æ–≤–∏–π –≤–∏–±—ñ—Ä –ø—Ä–æ—Ç–∏ –≥–µ—Ä–æ—ó–≤, —è–∫—ñ –ø–æ–∫–ª–∞–¥–∞—é—Ç—å—Å—è –Ω–∞ —â–∏—Ç–∏.</i>
‚Ä¢ <b>–ì–ª—É (Gloo):</b> –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —Ç–∞–Ω–∫/–±–æ—î—Ü—å, —â–æ –∑–¥–∞—Ç–µ–Ω —Ä–æ–∑–¥—ñ–ª—è—Ç–∏ –≤–æ—Ä–æ–∂—É –∫–æ–º–∞–Ω–¥—É —Ç–∞ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ö–∞–æ—Å. –ô–æ–≥–æ —É–ª—å—Ç—ñ–º–µ–π—Ç –¥–æ–∑–≤–æ–ª—è—î –ø—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏—Å—è –¥–æ –Ω–∞–π–±—ñ–ª—å—à –Ω–µ–±–µ–∑–ø–µ—á–Ω–æ–≥–æ –≤–æ—Ä–æ–≥–∞, –∫–æ–Ω—Ç—Ä–æ–ª—é—é—á–∏ –π–æ–≥–æ —Ç–∞ –∑–∞–≤–¥–∞—é—á–∏ —à–∫–æ–¥–∏. <i>–í—ñ–¥–º—ñ–Ω–Ω–æ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥—ñ–π —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é –∫–ª—é—á–æ–≤–∏—Ö —Ü—ñ–ª–µ–π.</i>

üí° <b>–ö–ª—é—á–æ–≤—ñ –ø–æ—Ä–∞–¥–∏ –¥–ª—è –µ–∫—Å–ø –ª–∞–π–Ω–µ—Ä–∞:</b>
‚Ä¢ <b>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Ñ–∞—Ä–º:</b> –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π —Ö–≤–∏–ª—ñ –º—ñ–Ω—å–π–æ–Ω—ñ–≤, —Ü–µ —Ç–≤–æ—î –∑–æ–ª–æ—Ç–æ —Ç–∞ –¥–æ—Å–≤—ñ–¥.
‚Ä¢ <b>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—Ä—Ç–∏:</b> –ü—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è 2-3 —Ä—ñ–≤–Ω—è –∞–∫—Ç–∏–≤–Ω–æ —Å–ª—ñ–¥–∫—É–π –∑–∞ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è–º –≤–æ—Ä–æ–∂–æ–≥–æ –ª—ñ—Å–Ω–∏–∫–∞ —Ç–∞ –≥—Ä–∞–≤—Ü—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ—ó –ª—ñ–Ω—ñ—ó. –ë—É–¥—å –≥–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Å–≤–æ—ó–π –∫–æ–º–∞–Ω–¥—ñ.
‚Ä¢ <b>–û–±'—î–∫—Ç–∏ ‚Äì —Ç–≤–æ—è —Ü—ñ–ª—å:</b> –î–æ–ø–æ–º–∞–≥–∞–π –∫–æ–º–∞–Ω–¥—ñ –∑ –ß–µ—Ä–µ–ø–∞—Ö–æ—é —Ç–∞ –õ–æ—Ä–¥–æ–º. –Ü–Ω—ñ—Ü—ñ—é–π –ø—É—à –ª—ñ–Ω—ñ—ó, –∫–æ–ª–∏ —Ü–µ –±–µ–∑–ø–µ—á–Ω–æ —Ç–∞ –¥–æ—Ü—ñ–ª—å–Ω–æ.
‚Ä¢ <b>–Ü–Ω—ñ—Ü—ñ–∞—Ü—ñ—è –∞–±–æ –∑–∞—Ö–∏—Å—Ç:</b> –ó–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –æ–±—Ä–∞–Ω–æ–≥–æ –≥–µ—Ä–æ—è —Ç–∞ —Å–∏—Ç—É–∞—Ü—ñ—ó –≤ –≥—Ä—ñ, —Ç–∏ –º–æ–∂–µ—à –±—É—Ç–∏ —Ç–∏–º, —Ö—Ç–æ –ø–æ—á–∏–Ω–∞—î —Ç—ñ–º—Ñ–∞–π—Ç, –∞–±–æ —Ç–∏–º, —Ö—Ç–æ –∑–∞—Ö–∏—â–∞—î —Å–≤–æ—ó—Ö —Å–æ—é–∑–Ω–∏–∫—ñ–≤.

ü§ù <b>–ü—Ä–∏–∫–ª–∞–¥ —Å–∏–Ω–µ—Ä–≥—ñ—ó/–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó:</b>
–Ø–∫—â–æ —É —Ç–≤–æ—ó–π –∫–æ–º–∞–Ω–¥—ñ —î –≥–µ—Ä–æ–π –∑ –º–∞—Å–æ–≤–∏–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, <i>–ê—Ç–ª–∞—Å</i> –∞–±–æ <i>–¢—ñ–≥—Ä—ñ–ª</i>, –≥–µ—Ä–æ—ó —è–∫ <i>–Æ –ß–∂—É–Ω</i> –∞–±–æ <i>–õ–∞–ø—É-–õ–∞–ø—É</i> –Ω–∞ –µ–∫—Å–ø –ª—ñ–Ω—ñ—ó –º–æ–∂—É—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å–≤—ñ–π –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª —à–∫–æ–¥–∏ –ø—ñ—Å–ª—è –≤–¥–∞–ª–æ—ó —ñ–Ω—ñ—Ü—ñ–∞—Ü—ñ—ó –≤—ñ–¥ —Ç–∞–Ω–∫–∞. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —É–ª—å—Ç—ñ–º–µ–π—Ç –ê—Ç–ª–∞—Å–∞ –∑–±–∏—Ä–∞—î –≤–æ—Ä–æ–≥—ñ–≤, –∞ –Æ –ß–∂—É–Ω –≤–ª—ñ—Ç–∞—î –≤ –Ω–∏—Ö –¥—Ä–∞–∫–æ–Ω–æ–º.

<b>–¢–≤—ñ–π —É—Å–ø—ñ—Ö –Ω–∞ –µ–∫—Å–ø –ª—ñ–Ω—ñ—ó</b> ‚Äì —Ü–µ –ø–æ—î–¥–Ω–∞–Ω–Ω—è —Ç–µ—Ä–ø—ñ–Ω–Ω—è, –≥–ª–∏–±–æ–∫–æ–≥–æ —Ä–æ–∑—É–º—ñ–Ω–Ω—è –∫–∞—Ä—Ç–∏ —Ç–∞ –≤–º—ñ–Ω–Ω—è –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ –≤–∏–±—ñ—Ä –≥–µ—Ä–æ—è –ø—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É —Å–∏—Ç—É–∞—Ü—ñ—é —Ç–∞ —Å–∫–ª–∞–¥ –∫–æ–º–∞–Ω–¥–∏. –ù–µ –±—ñ–π—Å—è –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É–≤–∞—Ç–∏ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –≥–µ—Ä–æ—è–º–∏! –ì–æ—Ç–æ–≤–∏–π –¥–æ–º—ñ–Ω—É–≤–∞—Ç–∏? üöÄ"

## –ó–ê–ü–ò–¢ –í–Ü–î {user_name}: "{user_query}"

–¢–≤–æ—è –µ–∫—Å–ø–µ—Ä—Ç–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–¥–æ—Ç—Ä–∏–º—É–π—Å—è –í–°–Ü–• —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ñ–≤ –≤–∏—â–µ, –æ—Å–æ–±–ª–∏–≤–æ —â–æ–¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ –≥–µ—Ä–æ—ó–≤):"""

    def _beautify_response(self, text: str) -> str:
        """
        –û—Ñ–æ—Ä–º–ª—é—î —Ç–µ–∫—Å—Ç GPT –¥–ª—è Telegram: –∑–∞–º—ñ–Ω—é—î markdown/–∑–∞–≥–æ–ª–æ–≤–∫–∏, –¥–æ–¥–∞—î –µ–º–æ–¥–∑—ñ, –≤—ñ–¥—Å—Ç—É–ø–∏.
        """
        # –ï–º–æ–¥–∑—ñ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π MLBB
        header_emojis = {
            "–∫–∞—Ä—Ç–∏": "üó∫Ô∏è", "–æ–±'—î–∫—Ç—ñ–≤": "üõ°Ô∏è", "—Ç–∞–∫—Ç–∏–∫–∞": "‚öîÔ∏è", "–ø–æ–∑–∏—Ü—ñ—è": "üìç",
            "–∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è": "üí¨", "–≥–µ—Ä–æ—è": "ü¶∏", "–≥–µ—Ä–æ—ó–≤": "ü¶∏‚Äç‚ôÇÔ∏èü¶∏‚Äç‚ôÄÔ∏è", "—Ñ–∞—Ä–º": "üí∞", "—Ä–æ—Ç–∞—Ü—ñ—è": "üîÑ",
            "–∫–æ–º–∞–Ω–¥–Ω–∞ –≥—Ä–∞": "ü§ù", "–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó": "ü§ù", "—Å–∏–Ω–µ—Ä–≥—ñ—è": "‚ú®", "—Ä–∞–Ω–∫": "üèÜ", 
            "—Å—Ç—Ä–∞—Ç–µ–≥—ñ": "üéØ", "–º–µ—Ç–∞": "üî•", "–ø–æ—Ç–æ—á–Ω–∞ –º–µ—Ç–∞": "üìä",
            "–Ω–∞–≤–∏—á–∫–∏": "üìà", "—Ç–∞–π–º–∏–Ω–≥": "‚è∞", "–∫–æ–Ω—Ç—Ä–æ–ª—å": "üéÆ", "–ø—É—à": "‚¨ÜÔ∏è",
            "–ø–æ—Ä–∞–¥–∏": "üí°", "–∫–ª—é—á–æ–≤—ñ –ø–æ—Ä–∞–¥–∏": "üí°"
        }

        def replace_header(match):
            header_text = match.group(1).strip(": ").capitalize()
            # –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –±—ñ–ª—å—à —Ç–æ—á–Ω–∏–π –µ–º–æ–¥–∑—ñ
            best_emoji = "üí°" # –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –µ–º–æ–¥–∑—ñ –¥–ª—è –∑–∞–≥–∞–ª—å–Ω–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
            
            # –°–ø–æ—á–∞—Ç–∫—É –¥–ª—è –±—ñ–ª—å—à –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –∫–ª—é—á—ñ–≤
            specific_keys = ["–≥–µ—Ä–æ—ó–≤", "–≥–µ—Ä–æ—è", "–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó", "—Å–∏–Ω–µ—Ä–≥—ñ—è", "–∫–ª—é—á–æ–≤—ñ –ø–æ—Ä–∞–¥–∏", "–ø–æ—Ç–æ—á–Ω–∞ –º–µ—Ç–∞"]
            for key in specific_keys:
                if key in header_text.lower():
                    best_emoji = header_emojis.get(key, best_emoji)
                    break
            else: # –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Å–µ—Ä–µ–¥ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏—Ö, —à—É–∫–∞—î–º–æ —Å–µ—Ä–µ–¥ –∑–∞–≥–∞–ª—å–Ω–∏—Ö
                for key, emj in header_emojis.items():
                    if key in header_text.lower():
                        best_emoji = emj
                        break
            
            return f"\n\n{best_emoji} <b>{header_text}</b>:"

        # –ó–∞–º—ñ–Ω—é—î–º–æ markdown –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ –µ–º–æ–¥–∑—ñ+–∂–∏—Ä–Ω–∏–π
        text = re.sub(r"^#{2,3}\s*(.+)", replace_header, text, flags=re.MULTILINE)
        text = re.sub(r"^\*\*(.+?)\*\*[:\s]*", replace_header, text, flags=re.MULTILINE) # –î–ª—è **–ó–∞–≥–æ–ª–æ–≤–æ–∫:**
        text = re.sub(r"^<b>(.+?)</b>[:\s]*", lambda m: replace_header(m) if ':' in m.group(0) else m.group(0), text, flags=re.MULTILINE) # –î–ª—è <b>–ó–∞–≥–æ–ª–æ–≤–æ–∫</b>:

        # –°–ø–∏—Å–∫–∏ –Ω–∞ "‚Ä¢ "
        text = re.sub(r"^\s*[\-\*]\s+", "‚Ä¢ ", text, flags=re.MULTILINE)
        text = re.sub(r"^\s*‚Ä¢\s+-\s+", "  ‚ó¶ ", text, flags=re.MULTILINE) # –¥–ª—è –ø—ñ–¥–ø—É–Ω–∫—Ç—ñ–≤ —Ç–∏–ø—É "‚Ä¢ - –ø—ñ–¥–ø—É–Ω–∫—Ç"
        
        # –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∑–∞–π–≤—ñ –ø–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤
        text = re.sub(r"\n{3,}", "\n\n", text)
        
        # –û—á–∏—â–µ–Ω–Ω—è –≤—ñ–¥ markdown –∑–∞–ª–∏—à–∫—ñ–≤ (—è–∫—â–æ GPT –≤—Å–µ –∂ —ó—Ö –¥–æ–¥–∞—Å—Ç—å)
        text = re.sub(r"\*\*(.+?)\*\*", r"<b>\1</b>", text)
        text = re.sub(r"\*(.+?)\*", r"<i>\1</i>", text)
        
        return text.strip()

    async def get_response(self, user_name: str, user_query: str) -> str:
        """
        –û—Ç—Ä–∏–º—É—î —è–∫—ñ—Å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ GPT —ñ –æ—Ñ–æ—Ä–º–ª—é—î —ó—ó –¥–ª—è Telegram.
        """
        system_prompt = self._create_smart_prompt(user_name, user_query)
        payload = {
            "model": "gpt-4.1", # –ê–±–æ "gpt-4.1" —è–∫—â–æ —Ü–µ –ø—Å–µ–≤–¥–æ–Ω—ñ–º –¥–ª—è –Ω–æ–≤—ñ—à–æ—ó –º–æ–¥–µ–ª—ñ
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_query}
            ],
            "max_tokens": 700, # –¢—Ä–æ—Ö–∏ –∑–±—ñ–ª—å—à–∏–º–æ, —Ç–∞–∫ —è–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å—Ç–∞–Ω—É—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ñ—à–∏–º–∏
            "temperature": 0.75, # –ó–º–µ–Ω—à–∏–º–æ —Ç—Ä–æ—Ö–∏ –¥–ª—è –±—ñ–ª—å—à–æ—ó —Ç–æ—á–Ω–æ—Å—Ç—ñ –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º–∏ –≥–µ—Ä–æ—è–º–∏
            "top_p": 0.9,
            "presence_penalty": 0.1,
            "frequency_penalty": 0.2 # –¢—Ä–æ—Ö–∏ –∑–±—ñ–ª—å—à–∏–º–æ, —â–æ–± —Å—Ç–∏–º—É–ª—é–≤–∞—Ç–∏ —Ä—ñ–∑–Ω–æ–º–∞–Ω—ñ—Ç–Ω—ñ—Å—Ç—å –≥–µ—Ä–æ—ó–≤
        }

        try:
            if not self.session or self.session.closed:
                # –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä—é—î–º–æ —Å–µ—Å—ñ—é, —è–∫—â–æ –≤–æ–Ω–∞ –∑–∞–∫—Ä–∏—Ç–∞ –∞–±–æ –Ω–µ —ñ—Å–Ω—É—î
                self.session = ClientSession(
                    timeout=ClientTimeout(total=45), # –¢—Ä–æ—Ö–∏ –∑–±—ñ–ª—å—à–∏–º–æ —Ç–∞–π–º–∞—É—Ç
                    headers={"Authorization": f"Bearer {self.api_key}"}
                )

            async with self.session.post(
                "https://api.openai.com/v1/chat/completions",
                json=payload
            ) as response:
                if response.status != 200:
                    error_text = await response.text()
                    logger.error(f"OpenAI API –ø–æ–º–∏–ª–∫–∞: {response.status} - {error_text}")
                    return f"–í–∏–±–∞—á, {user_name}, –≤–∏–Ω–∏–∫–ª–∏ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –¥–æ—Å—Ç—É–ø–æ–º –¥–æ –®–Ü üòî (–∫–æ–¥: {response.status}). –°–ø—Ä–æ–±—É–π, –±—É–¥—å –ª–∞—Å–∫–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç —Ç—Ä–æ—Ö–∏ –ø—ñ–∑–Ω—ñ—à–µ!"

                result = await response.json()
                
                if not result.get("choices") or not result["choices"][0].get("message") or not result["choices"][0]["message"].get("content"):
                    logger.error(f"OpenAI API –ø–æ–º–∏–ª–∫–∞: –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ - {result}")
                    return f"–í–∏–±–∞—á, {user_name}, –®–Ü –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å ü§Ø. –°–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª—é–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç."

                gpt_text = result["choices"][0]["message"]["content"]
                return self._beautify_response(gpt_text)

        except asyncio.TimeoutError:
            logger.error(f"OpenAI API Timeout –ø–æ–º–∏–ª–∫–∞ –¥–ª—è –∑–∞–ø–∏—Ç—É: {user_query}")
            return f"–í–∏–±–∞—á, {user_name}, –∑–∞–ø–∏—Ç –¥–æ –®–Ü –∑–∞–π–Ω—è–≤ –∑–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ —á–∞—Å—É ‚è≥. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑!"
        except Exception as e:
            logger.exception(f"–ó–∞–≥–∞–ª—å–Ω–∞ GPT –ø–æ–º–∏–ª–∫–∞: {e}")
            return f"–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ —Ç–≤—ñ–π –∑–∞–ø–∏—Ç, {user_name} üòï –°–ø—Ä–æ–±—É–π, –±—É–¥—å –ª–∞—Å–∫–∞, –ø—ñ–∑–Ω—ñ—à–µ!"


bot = Bot(
    token=TELEGRAM_BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()


@dp.message(CommandStart())
async def cmd_start(message: Message) -> None:
    """–ü—Ä–æ—Å—Ç–µ —Ç–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–µ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è."""
    user_name = message.from_user.first_name
    
    kyiv_tz = timezone(timedelta(hours=3))
    current_time_kyiv = datetime.now(kyiv_tz)
    current_hour = current_time_kyiv.hour

    if 5 <= current_hour < 12:
        greeting = "–î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É"
        emoji = "üåÖ"
    elif 12 <= current_hour < 17:
        greeting = "–î–æ–±—Ä–æ–≥–æ –¥–Ω—è"  
        emoji = "‚òÄÔ∏è"
    elif 17 <= current_hour < 22:
        greeting = "–î–æ–±—Ä–æ–≥–æ –≤–µ—á–æ—Ä–∞"
        emoji = "üåÜ"
    else:
        greeting = "–î–æ–±—Ä–æ—ó –Ω–æ—á—ñ"
        emoji = "üåô"

    welcome_text = f"""
{greeting}, <b>{user_name}</b>! {emoji}

üéÆ –í—ñ—Ç–∞—é –≤ MLBB IUI mini v2.1!

–Ø - —Ç–≤—ñ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –µ–∫—Å–ø–µ—Ä—Ç –ø–æ Mobile Legends Bang Bang, –≥–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑ –±—É–¥—å-—è–∫–∏–º–∏ –ø–∏—Ç–∞–Ω–Ω—è–º–∏ –ø—Ä–æ –≥—Ä—É, –Ω–∞–¥–∞—é—á–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –ø–æ—Ä–∞–¥–∏ —Ç–∞ –ø—Ä–∏–∫–ª–∞–¥–∏ –≥–µ—Ä–æ—ó–≤!

<b>üí° –Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è:</b>
–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è –ø—ñ—Å–ª—è –∫–æ–º–∞–Ω–¥–∏ /go

<b>üöÄ –ü—Ä–∏–∫–ª–∞–¥–∏ –∑–∞–ø–∏—Ç—ñ–≤:</b>
‚Ä¢ <code>/go —è–∫ –≥—Ä–∞—Ç–∏ –Ω–∞ –µ–∫—Å–ø –ª—ñ–Ω—ñ—ó –ø—Ä–æ—Ç–∏ –±—ñ–π—Ü—ñ–≤</code>
‚Ä¢ <code>/go –ø–æ—Ä–∞–¥—å —Å–∏–ª—å–Ω–∏—Ö –º–∞–≥—ñ–≤ –¥–ª—è –ø—ñ–¥–Ω—è—Ç—Ç—è —Ä–∞–Ω–≥—É —Å–æ–ª–æ</code>
‚Ä¢ <code>/go –Ω–∞–π–∫—Ä–∞—â—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –≥–µ—Ä–æ—ó–≤ –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω–∏—Ö –±–æ—ó–≤ 5–Ω–∞5</code>
‚Ä¢ <code>/go —è–∫ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É —Ç–∞ –æ–±'—î–∫—Ç–∏ –≥—Ä–∞—é—á–∏ –∑–∞ –ª—ñ—Å–Ω–∏–∫–∞</code>

<b>üî• –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è v2.1:</b>
‚Ä¢ –í—ñ–¥–ø–æ–≤—ñ–¥—ñ —Ç–µ–ø–µ—Ä –≤–∫–ª—é—á–∞—é—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ –≥–µ—Ä–æ—ó–≤!
‚Ä¢ –ü–æ—Ä–∞–¥–∏ —Å—Ç–∞–ª–∏ –±—ñ–ª—å—à –ø—Ä–∞–∫—Ç–∏—á–Ω–∏–º–∏ —Ç–∞ –º–µ–Ω—à "—Å—É—Ö–∏–º–∏".
‚Ä¢ –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ñ–π –º–µ—Ç—ñ —Ç–∞ —Å–∏–Ω–µ—Ä–≥—ñ—ó –≥–µ—Ä–æ—ó–≤.

–ì–æ—Ç–æ–≤–∏–π —Å—Ç–∞—Ç–∏ —Ç–≤–æ—ó–º –Ω–∞–π–∫—Ä–∞—â–∏–º MLBB —Ç—ñ–º–º–µ–π—Ç–æ–º! üí™‚ú®
"""
    await message.answer(welcome_text)
    logger.info(f"‚úÖ –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –¥–ª—è {user_name} (v2.1)")


@dp.message(Command("go"))
async def cmd_go(message: Message) -> None:
    """–ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è - —è–∫—ñ—Å–Ω–µ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ GPT –∑ –∫—Ä–∞—Å–∏–≤–∏–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è–º."""
    user_name = message.from_user.first_name
    user_query = message.text.replace("/go", "", 1).strip()

    if not user_query:
        await message.reply(
            f"–ü—Ä–∏–≤—ñ—Ç, <b>{user_name}</b>! üëã\n\n"
            "–ù–∞–ø–∏—à–∏ —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è –ø—ñ—Å–ª—è /go, —ñ —è —Å–ø—Ä–æ–±—É—é –¥–∞—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –ø–æ—Ä–∞–¥–∏ –∑ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏ –≥–µ—Ä–æ—ó–≤!\n"
            "<b>–ü—Ä–∏–∫–ª–∞–¥–∏:</b>\n"
            "‚Ä¢ /go —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ä–∞–Ω–∫-–∞–ø—É –Ω–∞ —Å—Ç—Ä—ñ–ª—å—Ü—è—Ö\n"
            "‚Ä¢ /go —è–∫–∏—Ö –≥–µ—Ä–æ—ó–≤ –æ–±—Ä–∞—Ç–∏ –¥–ª—è –¥–æ–º—ñ–Ω–∞—Ü—ñ—ó –Ω–∞ –º—ñ–¥—ñ"
        )
        return

    thinking_messages = [
        f"ü§î {user_name}, –∞–Ω–∞–ª—ñ–∑—É—é —Ç–≤—ñ–π –∑–∞–ø–∏—Ç —Ç–∞ –ø—ñ–¥–±–∏—Ä–∞—é –≥–µ—Ä–æ—ó–≤...",
        f"üß† –û–±—Ä–æ–±–ª—è—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é, {user_name}, —â–æ–± –¥–∞—Ç–∏ –∫—Ä–∞—â—ñ –ø–æ—Ä–∞–¥–∏!",
        f"‚ö° –ì–æ—Ç—É—é –µ–∫—Å–ø–µ—Ä—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±–µ!",
        f"üéØ {user_name}, —à—É–∫–∞—é –Ω–∞–π–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à–∏—Ö –≥–µ—Ä–æ—ó–≤ —Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó –¥–ª—è —Ç–µ–±–µ!"
    ]

    thinking_msg = await message.reply(
        thinking_messages[hash(user_query + str(time.time())) % len(thinking_messages)]
    )

    start_time = time.time()

    # –°—Ç–≤–æ—Ä—é—î–º–æ –µ–∫–∑–µ–º–ø–ª—è—Ä MLBBChatGPT —Ç—É—Ç, —â–æ–± —Å–µ—Å—ñ—è –±—É–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Ç—É
    async with MLBBChatGPT(OPENAI_API_KEY) as gpt:
        response_text = await gpt.get_response(user_name, user_query)

    processing_time = time.time() - start_time

    admin_info = ""
    if message.from_user.id == ADMIN_USER_ID:
        admin_info = f"\n\n<i>‚è± {processing_time:.2f}—Å | v2.1 Enhanced GPT-4T</i>"

    try:
        await thinking_msg.edit_text(f"{response_text}{admin_info}")
        logger.info(f"üì§ –í—ñ–¥–ø–æ–≤—ñ–¥—å –¥–ª—è {user_name} ({processing_time:.2f}s): –ó–∞–ø–∏—Ç - '{user_query}'")
    except TelegramAPIError as e:
        logger.error(f"Telegram API –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: {e}. –°–ø—Ä–æ–±–∞ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –Ω–æ–≤–∏–º.")
        try:
            await message.reply(f"{response_text}{admin_info}")
            logger.info(f"üì§ –í—ñ–¥–ø–æ–≤—ñ–¥—å –¥–ª—è {user_name} (–Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –Ω–æ–≤–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–∫–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è)")
        except Exception as final_e:
            logger.error(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞–≤—ñ—Ç—å –Ω–æ–≤–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º: {final_e}")
            await message.reply(f"–í–∏–±–∞—á, {user_name}, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.")


@dp.errors()
async def error_handler(update_event, exception: Exception):
    logger.error(f"üö® –ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ –æ–±—Ä–æ–±–Ω–∏–∫—É: {exception} –¥–ª—è update: {update_event}", exc_info=True)
    
    chat_id = None
    user_name = "–¥—Ä—É–∂–µ"

    if hasattr(update_event, 'message') and update_event.message:
        chat_id = update_event.message.chat.id
        if update_event.message.from_user:
            user_name = update_event.message.from_user.first_name
    elif hasattr(update_event, 'callback_query') and update_event.callback_query:
        chat_id = update_event.callback_query.message.chat.id
        if update_event.callback_query.from_user:
            user_name = update_event.callback_query.from_user.first_name
    
    error_message_text = f"–í–∏–±–∞—á, {user_name}, —Å—Ç–∞–ª–∞—Å—è –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–∞ –ø–æ–º–∏–ª–∫–∞ üòî\n–°–ø—Ä–æ–±—É–π, –±—É–¥—å –ª–∞—Å–∫–∞, —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Ö–≤–∏–ª–∏–Ω—É!"
    
    if chat_id:
        try:
            await bot.send_message(chat_id, error_message_text)
        except Exception as e:
            logger.error(f"üö® –ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É {user_name} –≤ —á–∞—Ç {chat_id}: {e}")
    else:
        logger.warning("üö® –ü–æ–º–∏–ª–∫–∞ —Å—Ç–∞–ª–∞—Å—è, –∞–ª–µ –Ω–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ chat_id –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.")


async def main() -> None:
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞."""
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ MLBB IUI mini v2.1...")

    # –°—Ç–≤–æ—Ä—é—î–º–æ —Å–µ—Å—ñ—é –¥–ª—è –±–æ—Ç–∞ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
    # bot._session = ClientSession() # –¶–µ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π —Å–ø–æ—Å—ñ–±, –∫—Ä–∞—â–µ —á–µ—Ä–µ–∑ default bot properties –∞–±–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä

    try:
        bot_info = await bot.get_me()
        logger.info(f"‚úÖ –ë–æ—Ç @{bot_info.username} –≥–æ—Ç–æ–≤–∏–π!")

        if ADMIN_USER_ID:
            try:
                kyiv_tz = timezone(timedelta(hours=3))
                launch_time_kyiv = datetime.now(kyiv_tz).strftime('%Y-%m-%d %H:%M:%S %Z')
                
                await bot.send_message(
                    ADMIN_USER_ID,
                    f"ü§ñ <b>MLBB IUI mini v2.1 –∑–∞–ø—É—â–µ–Ω–æ!</b>\n\n"
                    f"üÜî @{bot_info.username}\n"
                    f"‚è∞ {launch_time_kyiv}\n"
                    f"üéØ <b>–ü—Ä–æ–º–ø—Ç v2.1 –∞–∫—Ç–∏–≤–Ω–∏–π (–∑ –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –≥–µ—Ä–æ—è—Ö)!</b>\n"
                    f"üü¢ –ì–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏!"
                )
                logger.info(f"‚ÑπÔ∏è –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–ø—É—Å–∫ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∞–¥–º—ñ–Ω—É ID: {ADMIN_USER_ID}")
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–ø—É—Å–∫ –∞–¥–º—ñ–Ω—É: {e}")

        # –ü–æ—á–∏–Ω–∞—î–º–æ –æ–±—Ä–æ–±–∫—É –∞–ø–¥–µ–π—Ç—ñ–≤
        await dp.start_polling(bot)

    except KeyboardInterrupt:
        logger.info("üëã –ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º (KeyboardInterrupt)")
    except TelegramAPIError as e:
        logger.critical(f"üí• –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ Telegram API –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É: {e}")
    except Exception as e:
        logger.critical(f"üí• –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É: {e}", exc_info=True)
    finally:
        logger.info("üõë –ó–∞–∫—Ä–∏—Ç—Ç—è —Å–µ—Å—ñ–π...")
        # –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —Å–µ—Å—ñ—é Dispatcher'–∞ (—è–∫—â–æ –≤–æ–Ω–∞ –±—É–ª–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞ —è–≤–Ω–æ, —Ç—É—Ç dp —Å–∞–º –∫–µ—Ä—É—î)
        # –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —Å–µ—Å—ñ—é –±–æ—Ç–∞
        if bot.session and not bot.session.closed:
            await bot.session.close()
            logger.info("–°–µ—Å—ñ—é –±–æ—Ç–∞ –∑–∞–∫—Ä–∏—Ç–æ.")
        # if MLBBChatGPT.instance and MLBBChatGPT.instance.session and not MLBBChatGPT.instance.session.closed:
        #     await MLBBChatGPT.instance.session.close() # –Ø–∫—â–æ –± —Å–µ—Å—ñ—è –±—É–ª–∞ —á–∞—Å—Ç–∏–Ω–æ—é –∫–ª–∞—Å—É MLBBChatGPT —è–∫ —Å–∏–Ω–≥–ª—Ç–æ–Ω
        #     logger.info("–°–µ—Å—ñ—é MLBBChatGPT –∑–∞–∫—Ä–∏—Ç–æ.")
        logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑—É–ø–∏–Ω–µ–Ω–æ.")


if __name__ == "__main__":
    asyncio.run(main())
